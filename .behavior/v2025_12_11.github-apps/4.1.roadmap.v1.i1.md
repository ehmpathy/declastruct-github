# Roadmap: GitHub Apps Implementation

## Overview

execution roadmap for `.behavior/v2025_12_11.github-apps/3.3.blueprint.v1.i1.md`

---

## Phase 1: Domain Objects

### 1.1 Create `DeclaredGithubAppPermissions.ts`

- [ ] create `src/domain.objects/DeclaredGithubAppPermissions.ts`
  - implements `DomainLiteral` pattern
  - includes all permission types (contents, pullRequests, issues, actions, administration, metadata, etc.)

**acceptance criteria:**
- file exports `DeclaredGithubAppPermissions` class extending `DomainLiteral`
- typescript compiles without errors

**verification:**
```bash
npm run test:types
```

### 1.2 Create `DeclaredGithubApp.ts`

- [ ] create `src/domain.objects/DeclaredGithubApp.ts`
  - follows `DeclaredGithubRepo.ts` pattern
  - unique key: `['owner', 'slug']`
  - nested: `{ permissions: DeclaredGithubAppPermissions }`

**acceptance criteria:**
- file exports `DeclaredGithubApp` class extending `DomainEntity`
- `DeclaredGithubApp.unique` is `['owner', 'slug']`
- typescript compiles without errors

**verification:**
```bash
npm run test:types
```

### 1.3 Create `DeclaredGithubAppInstallation.ts`

- [ ] create `src/domain.objects/DeclaredGithubAppInstallation.ts`
  - follows `DeclaredGithubBranch.ts` pattern (nested ref to parent)
  - unique key: `['app', 'targetType', 'targetLogin']`
  - nested: `{ app: DeclaredGithubApp }`

**acceptance criteria:**
- file exports `DeclaredGithubAppInstallation` class extending `DomainEntity`
- `DeclaredGithubAppInstallation.unique` is `['app', 'targetType', 'targetLogin']`
- typescript compiles without errors

**verification:**
```bash
npm run test:types
```

---

## Phase 2: Cast Functions

depends on: Phase 1

### 2.1 Create `castToDeclaredGithubApp.ts`

- [ ] create `src/domain.operations/app/castToDeclaredGithubApp.ts`
  - follows `castToDeclaredGithubRepo.ts` pattern
  - maps Octokit response to `DeclaredGithubApp`

**acceptance criteria:**
- function accepts Octokit app response shape
- returns `DeclaredGithubApp` instance
- typescript compiles without errors

**verification:**
```bash
npm run test:types
```

### 2.2 Create `castToDeclaredGithubAppInstallation.ts`

- [ ] create `src/domain.operations/appInstallation/castToDeclaredGithubAppInstallation.ts`
  - follows `castToDeclaredGithubBranch.ts` pattern
  - maps Octokit installation response to `DeclaredGithubAppInstallation`

**acceptance criteria:**
- function accepts Octokit installation response shape
- returns `DeclaredGithubAppInstallation` instance
- typescript compiles without errors

**verification:**
```bash
npm run test:types
```

---

## Phase 3: Read Operations

depends on: Phase 2

### 3.1 Create `getOneApp.ts`

- [ ] create `src/domain.operations/app/getOneApp.ts`
  - follows `getOneRepo.ts` pattern
  - supports `by.unique: { owner, slug }`
  - calls `GET /apps/{slug}` (public, no auth required)

**acceptance criteria:**
- function signature: `getOneApp({ by: { unique } }, context) → DeclaredGithubApp | null`
- returns `null` when app not found (404)
- typescript compiles without errors

**verification:**
```bash
npm run test:types
```

### 3.2 Create `getOneApp.integration.test.ts`

- [ ] create `src/domain.operations/app/getOneApp.integration.test.ts`
  - tests reading a known public app by slug

**acceptance criteria:**
- test passes when reading existing app
- test passes when reading non-existent app (returns null)

**verification:**
```bash
npm run test:integration -- getOneApp.integration.test.ts
```

### 3.3 Create `getOneAppInstallation.ts`

- [ ] create `src/domain.operations/appInstallation/getOneAppInstallation.ts`
  - follows `getOneBranch.ts` pattern
  - supports `by.unique`, `by.org`, `by.user`, `by.repo`
  - `by.unique` resolves to `by.org` or `by.user` based on `targetType`

**acceptance criteria:**
- function signature: `getOneAppInstallation({ by }, context) → DeclaredGithubAppInstallation | null`
- returns `null` when installation not found (404)
- typescript compiles without errors

**verification:**
```bash
npm run test:types
```

### 3.4 Create `getOneAppInstallation.integration.test.ts`

- [ ] create `src/domain.operations/appInstallation/getOneAppInstallation.integration.test.ts`
  - tests reading installation by org (requires existing installation)

**acceptance criteria:**
- test passes when reading existing installation
- test passes when reading non-existent installation (returns null)

**verification:**
```bash
npm run test:integration -- getOneAppInstallation.integration.test.ts
```

---

## Phase 4: Write Operations

depends on: Phase 3

### 4.1 Create `setApp.ts`

- [ ] create `src/domain.operations/app/setApp.ts`
  - follows `setRepo.ts` pattern but throws `HelpfulError` for create/update
  - `findsert`: return existing if found, else throw HelpfulError with registration URL
  - `upsert`: throw HelpfulError with settings URL (can't update via API)

**acceptance criteria:**
- `findsert` returns existing app if found
- `findsert` throws `HelpfulError` with `github.com/settings/apps/new` URL if not found
- `upsert` throws `HelpfulError` with settings URL
- error messages include app manifest for easy copy-paste

**verification:**
```bash
npm run test:types
```

### 4.2 Create `setApp.test.ts`

- [ ] create `src/domain.operations/app/setApp.test.ts`
  - tests HelpfulError content and manifest generation

**acceptance criteria:**
- test verifies `findsert` throws HelpfulError with correct URL when app not found
- test verifies `upsert` throws HelpfulError with settings URL
- test verifies error includes app manifest

**verification:**
```bash
npm run test:unit -- setApp.test.ts
```

### 4.3 Create `setAppInstallation.ts`

- [ ] create `src/domain.operations/appInstallation/setAppInstallation.ts`
  - throws `HelpfulError` with installation URL if not found
  - automates repo add/remove when `repositorySelection === 'selected'`

**acceptance criteria:**
- throws `HelpfulError` with installation URL if installation not found
- adds repos via `PUT /user/installations/{id}/repositories/{repo_id}` when needed
- removes repos via `DELETE /user/installations/{id}/repositories/{repo_id}` when needed
- returns updated installation

**verification:**
```bash
npm run test:types
```

### 4.4 Create `setAppInstallation.test.ts`

- [ ] create `src/domain.operations/appInstallation/setAppInstallation.test.ts`
  - tests HelpfulError for missing installation
  - tests repo sync logic

**acceptance criteria:**
- test verifies HelpfulError thrown when installation not found
- test verifies repo add/remove logic

**verification:**
```bash
npm run test:unit -- setAppInstallation.test.ts
```

### 4.5 Create `deleteAppInstallation.ts`

- [ ] create `src/domain.operations/appInstallation/deleteAppInstallation.ts`
  - throws `HelpfulError` with uninstall URL (requires App JWT, not automatable)

**acceptance criteria:**
- always throws `HelpfulError` with GitHub UI uninstall URL

**verification:**
```bash
npm run test:types
```

---

## Phase 5: DAOs

depends on: Phase 4

### 5.1 Create `DeclaredGithubAppDao.ts`

- [ ] create `src/access/daos/DeclaredGithubAppDao.ts`
  - uses `genDeclastructDao` factory
  - wires up `getOneApp` and `setApp`

**acceptance criteria:**
- exports `DeclaredGithubAppDao` created via `genDeclastructDao`
- `get.one.byUnique` calls `getOneApp`
- `set.findsert` and `set.upsert` call `setApp`
- typescript compiles without errors

**verification:**
```bash
npm run test:types
```

### 5.2 Create `DeclaredGithubAppInstallationDao.ts`

- [ ] create `src/access/daos/DeclaredGithubAppInstallationDao.ts`
  - uses `genDeclastructDao` factory
  - wires up `getOneAppInstallation`, `setAppInstallation`, `deleteAppInstallation`

**acceptance criteria:**
- exports `DeclaredGithubAppInstallationDao` created via `genDeclastructDao`
- `get.one.byUnique` calls `getOneAppInstallation`
- `set.findsert` and `set.upsert` call `setAppInstallation`
- `set.delete` calls `deleteAppInstallation`
- typescript compiles without errors

**verification:**
```bash
npm run test:types
```

---

## Phase 6: Provider Integration

depends on: Phase 5

### 6.1 Update `DeclastructGithubProvider.ts`

- [ ] update `src/domain.objects/DeclastructGithubProvider.ts`
  - add `DeclaredGithubApp` and `DeclaredGithubAppInstallation` to DAO types

**acceptance criteria:**
- provider type includes new DAO types
- typescript compiles without errors

**verification:**
```bash
npm run test:types
```

### 6.2 Update `getDeclastructGithubProvider.ts`

- [ ] update `src/domain.operations/provider/getDeclastructGithubProvider.ts`
  - wire up `DeclaredGithubAppDao` and `DeclaredGithubAppInstallationDao`

**acceptance criteria:**
- provider instance includes new DAOs
- typescript compiles without errors

**verification:**
```bash
npm run test:types
```

### 6.3 Update `src/contract/sdks/index.ts`

- [ ] export new domain objects:
  - `DeclaredGithubApp`
  - `DeclaredGithubAppPermissions`
  - `DeclaredGithubAppInstallation`

**acceptance criteria:**
- all three domain objects exported from SDK
- typescript compiles without errors

**verification:**
```bash
npm run test:types
```

---

## Phase 7: Acceptance Tests

depends on: Phase 6

### 7.1 Create acceptance test resources

- [ ] create `src/contract/sdks/.test/assets/resources.apps.acceptance.ts`
  - declares `declastruct-github-demo-app` and installation

**acceptance criteria:**
- exports `getProviders` and `getResources`
- resources include app and installation declarations

**verification:**
```bash
npm run test:types
```

### 7.2 Create acceptance tests

- [ ] create `src/contract/sdks/declastruct.apps.acceptance.test.ts`
  - tests `declastruct plan` succeeds
  - tests `declastruct apply` succeeds (KEEP) or throws HelpfulError

**acceptance criteria:**
- plan generates valid JSON with app and installation changes
- apply either succeeds or throws HelpfulError with guidance URL

**verification:**
```bash
npm run test:acceptance -- declastruct.apps.acceptance.test.ts
```

---

## Phase 8: Examples

depends on: Phase 6

### 8.1 Create workflow example

- [ ] create `examples/workflows/github-app-token.yml`
  - demonstrates `actions/create-github-app-token` usage

**acceptance criteria:**
- valid GitHub Actions workflow YAML
- shows token generation and usage with declastruct

**verification:**
```bash
# manual review - valid YAML syntax
```

### 8.2 Create resources example

- [ ] create `examples/resources/github-apps.ts`
  - shows app and installation declarations

**acceptance criteria:**
- valid TypeScript
- demonstrates declarative app configuration

**verification:**
```bash
npm run test:types
```

---

## Phase 9: Provision Files (Wish Fulfillment)

depends on: Phase 6

### 9.1 Create `resources.app.declastruct-github.ts`

- [ ] create `provision/github.apps/resources.app.declastruct-github.ts`
  - exports `getResourcesOfAppDeclastructGithub`
  - permissions: administration (write), contents (write), metadata (read)

**acceptance criteria:**
- exports async function returning app + installation
- correct permissions for repo management

**verification:**
```bash
npm run test:types
```

### 9.2 Create `resources.app.please-release.ts`

- [ ] create `provision/github.apps/resources.app.please-release.ts`
  - exports `getResourcesOfAppPleaseRelease`
  - permissions: contents (write), pullRequests (write), metadata (read)

**acceptance criteria:**
- exports async function returning app + installation
- correct permissions for release-please workflow

**verification:**
```bash
npm run test:types
```

### 9.3 Create `resources.ts`

- [ ] create `provision/github.apps/resources.ts`
  - exports `getProviders` and `getResources`
  - composes both app resource functions

**acceptance criteria:**
- exports `getProviders` returning github provider
- exports `getResources` composing both apps

**verification:**
```bash
npm run test:types
```

### 9.4 Update `provision/github.apps/readme.md`

- [ ] update readme with structure, usage, and workflow integration docs

**acceptance criteria:**
- documents file structure
- includes usage examples
- shows workflow integration

**verification:**
```bash
# manual review
```

---

## Phase 10: Workflow Integration

depends on: Phase 9

### 10.1 Update `.github/workflows/provision.yml`

- [ ] add `tokens` job to generate app token
- [ ] update `github` job to use app token

**acceptance criteria:**
- `tokens` job generates token via `actions/create-github-app-token@v2`
- `github` job passes token via `secrets.github-token`
- workflow syntax is valid

**verification:**
```bash
# manual review - valid YAML syntax
# full verification after org configuration
```

### 10.2 Configure org variables/secrets

- [ ] add org variable: `DECLASTRUCT_GITHUB_APP_ID`
- [ ] add org secret: `DECLASTRUCT_GITHUB_APP_PRIVATE_KEY`

**acceptance criteria:**
- variable contains app ID from GitHub App settings
- secret contains private key PEM contents

**verification:**
```bash
# trigger provision workflow - should succeed
```

### 10.3 Remove legacy secret

- [ ] remove `PROVISION_GITHUB_GITHUB_TOKEN` secret (after verification)

**acceptance criteria:**
- provision workflow runs successfully without legacy secret

**verification:**
```bash
# trigger provision workflow after removal
```

---

## Final Verification

### Build Verification

- [ ] all types compile: `npm run test:types`
- [ ] all unit tests pass: `npm run test:unit`
- [ ] all integration tests pass: `npm run test:integration`
- [ ] all acceptance tests pass: `npm run test:acceptance`

### End-to-End Verification

- [ ] `declastruct plan` works for `provision/github.apps/resources.ts`
- [ ] `declastruct apply` either succeeds (KEEP) or throws HelpfulError
- [ ] provision workflow generates app token and passes to declastruct

---

## Success Criteria Checklist

- [ ] declarative app definition: users can declare `DeclaredGithubApp` with permissions/events
- [ ] helpful errors: when automation isn't possible, actionable URLs are provided
- [ ] installation repo management: repos can be synced for existing installations
- [ ] workflow integration: `actions/create-github-app-token` example works
- [ ] pattern consistency: all code follows repo patterns
- [ ] wish fulfilled: `declastruct-github` and `please-release` apps declared and provisionable
