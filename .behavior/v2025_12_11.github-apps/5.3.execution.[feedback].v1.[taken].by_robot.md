# Feedback Response: GitHub Apps Implementation v1

tracking resolution of feedback blockers from human review

---

## Response Checklist

| blocker | status     | action                                                                                          |
| ------- | ---------- | ----------------------------------------------------------------------------------------------- |
| 1       | ✅ resolved | already implemented - fetch via getOneAppInstallation after sync instead of manual construction |
| 2       | ✅ resolved | refactored targetType/targetLogin to nested target: { type, slug }                              |
| 3       | ✅ resolved | simplified getOneAppInstallation to unique/primary only; removed org/user/repo lookups          |

---

## blocker.1: fetch after updates (already resolved)

**file:** `src/domain.operations/appInstallation/setAppInstallation.ts`

**status:** ✅ already fixed in previous session

**change:** replaced manual construction with fetch via getOneAppInstallation:

```ts
// before (manual construction - bad):
return new DeclaredGithubAppInstallation({
  ...foundBefore,
  repositories: result.repositories,
}) as HasMetadata<DeclaredGithubAppInstallation>;

// after (fetch real state - good):
const foundAfter = await getOneAppInstallation(
  { by: { unique: { app: desired.app, targetType: desired.targetType, targetLogin: desired.targetLogin } } },
  context,
);
if (!foundAfter)
  UnexpectedCodePathError.throw('installation not found after sync. should not be possible', { desired, result });
return foundAfter;
```

---

## blocker.2: refactor to nested target object ✅

**files updated:**
- [x] `src/domain.objects/DeclaredGithubAppInstallation.ts` - added DeclaredGithubAppInstallationTarget interface, changed unique key
- [x] `src/domain.operations/appInstallation/castToDeclaredGithubAppInstallation.ts` - composes target object
- [x] `src/domain.operations/appInstallation/getOneAppInstallation.ts` - updated unique key access
- [x] `src/domain.operations/appInstallation/setAppInstallation.ts` - updated unique key access
- [x] `src/domain.operations/appInstallation/deleteAppInstallation.ts` - updated URL construction
- [x] `src/domain.operations/appInstallation/*.test.ts` - updated test fixtures
- [x] `provision/github.apps/*.ts` - updated resource declarations

**before:**
```ts
targetType: 'Organization' | 'User';
targetLogin: string;
```

**after:**
```ts
target: {
  type: 'Organization' | 'User';
  slug: string;
}
```

---

## blocker.3: simplify getOneAppInstallation ✅

**file:** `src/domain.operations/appInstallation/getOneAppInstallation.ts`

**rationale:** getOne should only operate on unique or primary keys per declastruct pattern

**before:**
```ts
input: {
  by: PickOne<{
    unique: RefByUnique<typeof DeclaredGithubAppInstallation>;
    org: { org: string; app: RefByUnique<typeof DeclaredGithubApp> };
    user: { user: string; app: RefByUnique<typeof DeclaredGithubApp> };
    repo: { owner: string; repo: string; app: RefByUnique<typeof DeclaredGithubApp> };
  }>;
}
```

**after:**
```ts
input: {
  by: PickOne<{
    unique: RefByUnique<typeof DeclaredGithubAppInstallation>;
  }>;
}
```

**note:** org and user are addressable via the unique key .target; repo lookup is not supported as it's not a unique key for DeclaredGithubAppInstallation

---

## Verification ✅

- [x] `npm run test:types` passes
- [x] `npm run test:unit` passes (9 tests in 2 suites)
