# Self-Review: GitHub Apps Implementation

reviewing git diff since main against blueprint and mechanic practices

---

## BLOCKERs

### B1: Missing `.nested` declaration on `DeclaredGithubApp`

**file:** `src/domain.objects/DeclaredGithubApp.ts:82-87`

**issue:** `DeclaredGithubApp` has nested `permissions: DeclaredGithubAppPermissions` but the class doesn't declare `.nested`. per domain-objects pattern (see `DeclaredGithubBranch.ts:39-41`), nested domain objects must be declared for proper hydration.

**current:**
```ts
export class DeclaredGithubApp
  extends DomainEntity<DeclaredGithubApp>
  implements DeclaredGithubApp
{
  public static unique = ['owner', 'slug'] as const;
}
```

**required:**
```ts
export class DeclaredGithubApp
  extends DomainEntity<DeclaredGithubApp>
  implements DeclaredGithubApp
{
  public static unique = ['owner', 'slug'] as const;
  public static nested = {
    permissions: DeclaredGithubAppPermissions,
  };
}
```

**why blocker:** without this, when instantiating `DeclaredGithubApp` with a plain object for `permissions`, it won't be hydrated into a `DeclaredGithubAppPermissions` instance. this breaks domain object identity and serialization.

---

### B2: Missing return type for `DeclaredGithubAppInstallation` in `getResourcesOfAppDeclastructGithub`

**file:** `provision/github.apps/resources.app.declastruct-github.ts:10`

**issue:** function returns `Promise<any[]>` implicitly. should explicitly return `Promise<DomainEntity<any>[]>` per blueprint pattern.

**current:**
```ts
export const getResourcesOfAppDeclastructGithub = async () => {
```

**required:**
```ts
export const getResourcesOfAppDeclastructGithub = async (): Promise<DomainEntity<any>[]> => {
```

**why blocker:** violates `mech:clear-contracts` - explicit return types are required for exported procedures.

---

### B3: Missing return type for `getResourcesOfAppPleaseRelease`

**file:** `provision/github.apps/resources.app.please-release.ts`

**issue:** same as B2 - missing explicit return type.

---

## NITPICKs

### N1: IIFE pattern in `getOneApp.ts` is verbose

**file:** `src/domain.operations/app/getOneApp.ts:29-35`

**issue:** uses IIFE to extract slug, but could be simplified with early return.

**current:**
```ts
const { slug } = (() => {
  if (input.by.unique) return { slug: input.by.unique.slug };

  UnexpectedCodePathError.throw('not referenced by unique. how not?', {
    input,
  });
})();
```

**suggestion:** simplify to:
```ts
if (!input.by.unique)
  UnexpectedCodePathError.throw('not referenced by unique', { input });
const { slug } = input.by.unique;
```

---

### N2: Missing `DomainEntity` import in provision files

**file:** `provision/github.apps/resources.app.declastruct-github.ts`

**issue:** if we add explicit return type `Promise<DomainEntity<any>[]>`, we need to import `DomainEntity`.

---

### N3: Provision files reference `../../dist/contract/sdks`

**file:** `provision/github.apps/*.ts`

**issue:** using dist path means provision files won't work until after build. this is intentional for dogfooding but could be fragile. acceptable for this use case.

---

### N4: Missing test for `deleteAppInstallation`

**file:** `src/domain.operations/appInstallation/deleteAppInstallation.ts`

**issue:** unlike `setApp` and `setAppInstallation`, `deleteAppInstallation` doesn't have a dedicated test file. while it's a simple function that just throws, a test would document the expected behavior.

---

## Summary

| type    | count |
|---------|-------|
| BLOCKER | 3     |
| NITPICK | 4     |

---

## Resolution Priority

1. **B1** - add `.nested` to `DeclaredGithubApp` (critical for hydration)
2. **B2, B3** - add explicit return types to provision resource functions
3. **N1** - simplify IIFE (optional)
4. **N4** - add test for deleteAppInstallation (optional)
