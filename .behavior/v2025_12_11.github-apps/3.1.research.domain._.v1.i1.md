# Domain Research: GitHub Apps

## Overview

This research identifies the domain objects, events, literals, and operations required to fulfill the wish:
> "wish we could provision github apps so that we can subsequently use their tokens via this project"

---

## Domain Objects

### Entities

#### 1. GithubApp

The core entity representing a GitHub App registration.

**Properties:**
- `id` (integer): "Unique identifier" [1]
- `slug` (string): "URL-friendly name" [1]
- `name` (string): "Display name" [1]
- `owner` (object): "User or organization that owns the app" [1]
- `clientId` (string): "The GitHub App's client ID" [2]
- `clientSecret` (string): "The GitHub App's client secret" [2]
- `webhookSecret` (string): auto-generated webhook secret [3]
- `privateKey` (string): "Content from the downloaded `.pem` file" [2]
- `permissions` (object): "Granular permission mappings" [1]
- `events` (array): "Webhook event subscriptions" [1]
- `htmlUrl` (string): URL to the app's page
- `externalUrl` (string): External homepage URL
- `installationsCount` (integer): Number of installations [1]
- `createdAt` (datetime): Timestamp
- `updatedAt` (datetime): Timestamp

**Unique Key:** `['owner', 'slug']` or `['id']`

**Citations:**
> [1] "id (integer): Unique identifier, slug (string): URL-friendly name, name (string): Display name, owner (object): User or organization that owns the app, permissions (object): Granular permission mappings, events (array): Webhook event subscriptions, created_at, updated_at (timestamps), html_url, external_url (links), installations_count (integer, self-requests only)" - [REST API endpoints for GitHub Apps](https://docs.github.com/en/rest/apps/apps)

> [2] "appId (number): Required. Find on the app's settings page, privateKey (string): Typically required. Content from the downloaded .pem file, clientId (string): The GitHub App's client ID, clientSecret (string): The GitHub App's client secret" - [@octokit/auth-app.js](https://github.com/octokit/auth-app.js)

> [3] "The endpoint response includes: id (GitHub App ID), pem (private key file), webhook_secret (auto-generated), client_id, client_secret" - [Registering a GitHub App from a manifest](https://docs.github.com/en/apps/sharing-github-apps/registering-a-github-app-from-a-manifest)

---

#### 2. GithubAppInstallation

Represents an installation of a GitHub App on a user or organization account.

**Properties:**
- `id` (integer): "Unique installation identifier" [4]
- `appId` (integer): "Associated GitHub App identifier" [4]
- `appSlug` (string): "App name slug" [4]
- `targetId` (integer): "Organization or user ID" [4]
- `targetType` (string): "Organization" or "User" [4]
- `account` (object): "User/organization details" [4]
- `repositorySelection` (string): "all" or "selected" [4]
- `permissions` (object): "Granular permission settings" [4]
- `events` (array): "Webhook event subscriptions" [4]
- `singleFileName` (string): single-file restriction [4]
- `hasMultipleSingleFiles` (boolean): single-file mode [4]
- `singleFilePaths` (array): file paths [4]
- `suspendedAt` (datetime): suspension timestamp [4]
- `suspendedBy` (object): who suspended [4]
- `createdAt` (datetime): Timestamp
- `updatedAt` (datetime): Timestamp

**Unique Key:** `['id']` or `['appId', 'targetId', 'targetType']`

**Citations:**
> [4] "id (integer): Unique installation identifier, app_id (integer): Associated GitHub App identifier, app_slug (string): App name slug, target_id (integer): Organization or user ID, target_type (string): 'Organization' or 'User', account (object): User/organization details, repository_selection (string): 'all' or 'selected', permissions (object): Granular permission settings, events (array): Webhook event subscriptions, created_at, updated_at (date-time strings), suspended_at, suspended_by: Suspension status information, single_file_name, has_multiple_single_files, single_file_paths: Single-file restriction data" - [REST API endpoints for GitHub App installations](https://docs.github.com/en/rest/apps/installations)

---

#### 3. GithubAppInstallationAccessToken

A short-lived token for authenticating as a GitHub App installation.

**Properties:**
- `token` (string): "GitHub App installation access token" [5]
- `installationId` (integer): Installation this token is for
- `repositorySelection` (string): "all" or "selected"
- `repositories` (array): repositories the token can access
- `permissions` (object): granted permissions
- `expiresAt` (datetime): "Installation access tokens expire after 1 hour" [5]
- `createdAt` (datetime): when token was created

**Unique Key:** N/A (ephemeral resource)

**Citations:**
> [5] "Installation access tokens expire after 1 hour... Using an expired token produces a status code of 401 - Unauthorized, and requires creating a new installation token" - [REST API endpoints for GitHub App installations](https://docs.github.com/en/rest/apps/installations)

---

### Events

#### 1. installation

> [6] "This event occurs when there is activity relating to a GitHub App installation. All GitHub Apps receive this event by default." - [Webhook events and payloads](https://docs.github.com/en/webhooks/webhook-events-and-payloads)

**Action Types:**
- `created`: "Someone installed a GitHub App on a user or organization account" [6]
- `deleted`: App was uninstalled
- `suspend`: Installation was suspended
- `unsuspend`: Installation was unsuspended
- `new_permissions_accepted`: User accepted new permissions

**Payload Properties:**
- `action` (string, required)
- `installation` (object, required): Installation details
- `repositories` (array): Repository objects the installation can access
- `organization` (object): Present when configured for an organization
- `sender` (object, required): GitHub user who performed the action

---

#### 2. installation_target

> [7] "This event occurs when there is activity relating to the user or organization account that a GitHub App is installed on." - [Webhook events and payloads](https://docs.github.com/en/webhooks/webhook-events-and-payloads)

**Action Types:**
- `renamed`: "Somebody renamed the user or organization account that a GitHub App is installed on" [7]

**Payload Properties:**
- `action` (string, required)
- `account` (object, required): User or organization account
- `changes` (object, required): Details of what changed
- `installation` (object, required)
- `target_type` (string, required)

---

#### 3. github_app_authorization

> [8] "This event occurs when a user revokes their authorization of a GitHub App." - [Webhook events and payloads](https://docs.github.com/en/webhooks/webhook-events-and-payloads)

**Action Types:**
- `revoked`: "Someone revoked their authorization of a GitHub App" [8]

**Payload Properties:**
- `action` (string, required)
- `sender` (object, required): GitHub user who revoked authorization

---

### Literals

#### 1. GithubAppPermission

Permission levels for GitHub App capabilities.

**Repository Permissions:**
- `contents`: "Push code" and manage file operations [9]
- `actions`: Control workflow permissions and artifacts [9]
- `administration`: "set GitHub Actions permissions" and manage caches, budgets, and security settings [9]
- `pull_requests`: Manage code review processes [9]
- `issues`: Handle issue tracking and labels [9]
- `deployments`: Oversee release management [9]
- `checks`: Manage status reports [9]
- `code_scanning`: Review and manage security alerts [9]
- `secrets`: Handle repository-specific credentials [9]
- `metadata`: Basic repository information (implicit read)
- `workflows`: "access or edit Actions files in the .github/workflows directory" [10]

**Organization Permissions:**
- `administration`: Org-level admin [9]
- `members`: Manage invitations, memberships, and team assignments [9]
- `custom_properties`: Create schemas and manage property values [9]
- `blocking`: Control user blocks [9]
- `webhooks`: Configure organization event notifications [9]
- `secrets`: Organization-wide secrets [9]
- `projects`: Project management [9]
- `self_hosted_runners`: Runner infrastructure [9]

**Access Levels:**
- `read`: "View/retrieve data" [9]
- `write`: "Create, modify, or update data" [9]
- `admin`: "Full control including deletion and configuration" [9]

**Citations:**
> [9] "Access Levels Available: read: View/retrieve data, write: Create, modify, or update data, admin: Full control including deletion and configuration" - [Permissions required for GitHub Apps](https://docs.github.com/en/rest/authentication/permissions-required-for-github-apps)

> [10] "If your app specifically needs to access or edit Actions files in the .github/workflows directory, request the 'Workflows' repository permission" - [Permissions required for GitHub Apps](https://docs.github.com/en/rest/authentication/permissions-required-for-github-apps)

---

#### 2. GithubAppTargetType

```typescript
type GithubAppTargetType = 'Organization' | 'User';
```

---

#### 3. GithubAppRepositorySelection

```typescript
type GithubAppRepositorySelection = 'all' | 'selected';
```

---

#### 4. GithubAppVisibility

```typescript
type GithubAppVisibility = 'public' | 'private';
```

> [11] "public (boolean): Set true for public apps, false for private" - [Registering a GitHub App from a manifest](https://docs.github.com/en/apps/sharing-github-apps/registering-a-github-app-from-a-manifest)

---

## Domain Operations

### App Operations

#### getApp (GET /app)
> [12] "Retrieves the authenticated GitHub App and its installation count" - [REST API endpoints for GitHub Apps](https://docs.github.com/en/rest/apps/apps)

**Authentication:** JWT (app)

---

#### getAppBySlug (GET /apps/{app_slug})
> [13] "Retrieves public app information by slug" - [REST API endpoints for GitHub Apps](https://docs.github.com/en/rest/apps/apps)

**Authentication:** None (public info) or token

---

#### createAppFromManifest (POST /app-manifests/{code}/conversions)
> [14] "Completes the manifest flow handshake to get app credentials" - [REST API endpoints for GitHub Apps](https://docs.github.com/en/rest/apps/apps)

**Input:**
- `code` (string, path): Temporary code from redirect

**Output:**
- `id`: GitHub App ID
- `pem`: Private key
- `webhook_secret`: Generated secret
- `client_id`: OAuth client ID
- `client_secret`: OAuth client secret

**Flow:**
> [15] "The GitHub App Manifest flow uses a handshaking process similar to the OAuth flow. The flow uses a manifest to register a GitHub App and receives a temporary code used to retrieve the app's private key, webhook secret, and ID. You must complete all three steps in the GitHub App Manifest flow within one hour." - [Registering a GitHub App from a manifest](https://docs.github.com/en/apps/sharing-github-apps/registering-a-github-app-from-a-manifest)

---

### Installation Operations

#### getInstallations (GET /app/installations)
> [16] "Lists all installations for the authenticated app" - [REST API endpoints for GitHub Apps](https://docs.github.com/en/rest/apps/apps)

**Authentication:** JWT (app)

---

#### getInstallation (GET /app/installations/{installation_id})
> [17] "Fetches a specific installation's details" - [REST API endpoints for GitHub Apps](https://docs.github.com/en/rest/apps/apps)

**Authentication:** JWT (app)

---

#### getOrgInstallation (GET /orgs/{org}/installation)
> [18] "Finds an org's app installation" - [REST API endpoints for GitHub Apps](https://docs.github.com/en/rest/apps/apps)

**Authentication:** JWT (app) or token

---

#### getRepoInstallation (GET /repos/{owner}/{repo}/installation)
> [19] "Finds a repository's app installation" - [REST API endpoints for GitHub Apps](https://docs.github.com/en/rest/apps/apps)

**Authentication:** JWT (app) or token

---

#### getUserInstallation (GET /users/{username}/installation)
> [20] "Finds a user's app installation" - [REST API endpoints for GitHub Apps](https://docs.github.com/en/rest/apps/apps)

**Authentication:** JWT (app) or token

---

#### deleteInstallation (DELETE /app/installations/{installation_id})
> [21] "Uninstalls the app from an account" - [REST API endpoints for GitHub Apps](https://docs.github.com/en/rest/apps/apps)

**Authentication:** JWT (app)

---

#### suspendInstallation (PUT /app/installations/{installation_id}/suspended)
> [22] "Suspends an app installation" - [REST API endpoints for GitHub Apps](https://docs.github.com/en/rest/apps/apps)

**Authentication:** JWT (app)

---

#### unsuspendInstallation (DELETE /app/installations/{installation_id}/suspended)
> [23] "Removes installation suspension" - [REST API endpoints for GitHub Apps](https://docs.github.com/en/rest/apps/apps)

**Authentication:** JWT (app)

---

### Access Token Operations

#### createInstallationAccessToken (POST /app/installations/{installation_id}/access_tokens)
> [24] "Creates a scoped installation access token" - [REST API endpoints for GitHub Apps](https://docs.github.com/en/rest/apps/apps)

**Authentication:** JWT (app)

**Input (optional):**
- `repositories` (array): Specific repository names
- `repository_ids` (array): Specific repository IDs
- `permissions` (object): Subset of permissions

**Output:**
- `token`: The installation access token
- `expires_at`: Expiration timestamp
- `permissions`: Granted permissions
- `repository_selection`: "all" or "selected"
- `repositories`: Array of accessible repositories

> [25] "By default the installation token has access to all repositories that the installation can access. Optionally, you can use the repositories or repository_ids body parameters to specify individual repositories that the installation access token can access." - [REST API endpoints for GitHub App installations](https://docs.github.com/en/rest/apps/installations)

---

#### revokeInstallationAccessToken (DELETE /installation/token)
> [26] "Invalidates the current installation token being used for authentication. Requires a new token for subsequent operations." - [REST API endpoints for GitHub App installations](https://docs.github.com/en/rest/apps/installations)

**Authentication:** Installation access token

---

### Installation Repository Operations

#### listInstallationRepositories (GET /installation/repositories)
> [27] "List repositories that an app installation can access" - [REST API endpoints for GitHub App installations](https://docs.github.com/en/rest/apps/installations)

**Authentication:** Installation access token

---

#### addRepositoryToInstallation (PUT /user/installations/{installation_id}/repositories/{repository_id})
> [28] "Assigns a single repository to an installation; requires admin access" - [REST API endpoints for GitHub App installations](https://docs.github.com/en/rest/apps/installations)

**Authentication:** User access token

---

#### removeRepositoryFromInstallation (DELETE /user/installations/{installation_id}/repositories/{repository_id})
> [29] "Detaches a repository from an installation; requires admin repository access and 'selected' repository selection mode" - [REST API endpoints for GitHub App installations](https://docs.github.com/en/rest/apps/installations)

**Authentication:** User access token

---

## SDK Reference: @octokit/auth-app

For programmatic access, the `@octokit/auth-app` package provides authentication for GitHub Apps.

**Installation:**
```bash
npm install @octokit/auth-app
```

**Usage:**
> [30] "The @octokit/auth-app library implements GitHub App authentication using JSON Web Tokens, installation access tokens, and OAuth user-to-server tokens." - [@octokit/auth-app.js](https://github.com/octokit/auth-app.js)

```typescript
import { createAppAuth } from "@octokit/auth-app";

const auth = createAppAuth({
  appId: 1,
  privateKey: "-----BEGIN PRIVATE KEY-----\n...",
  clientId: "lv1.1234567890abcdef",
  clientSecret: "1234567890abcdef12341234567890abcdef1234",
});

// Get installation token
const installationAuth = await auth({
  type: "installation",
  installationId: 123,
});
// Returns: { type, tokenType, token, installationId, createdAt, expiresAt }
```

**Key Feature:**
> [31] "Automatic Token Caching: Installation tokens expire after one hour; the library caches up to 15,000 tokens by default" - [@octokit/auth-app.js](https://github.com/octokit/auth-app.js)

---

## GitHub Actions Integration: actions/create-github-app-token

For use in GitHub Actions workflows:

> [32] "GitHub Action for creating a GitHub App installation access token. The action generates tokens that expire after 1 hour and are automatically revoked at job completion unless skip-token-revoke is enabled." - [actions/create-github-app-token](https://github.com/actions/create-github-app-token)

**Inputs:**
| Input | Required | Description |
|-------|----------|-------------|
| `app-id` | Yes | GitHub App ID |
| `private-key` | Yes | GitHub App private key |
| `owner` | No | Repository owner for token scope |
| `repositories` | No | Comma-separated repository list |
| `permission-<name>` | No | Granular permission settings |
| `skip-token-revoke` | No | Prevents token revocation at job completion |

**Outputs:**
| Output | Description |
|--------|-------------|
| `token` | "GitHub App installation access token (masked)" [32] |
| `installation-id` | GitHub App installation ID |
| `app-slug` | GitHub App slug |

**Example:**
```yaml
steps:
  - uses: actions/create-github-app-token@v2
    id: app-token
    with:
      app-id: ${{ vars.APP_ID }}
      private-key: ${{ secrets.PRIVATE_KEY }}
  - uses: actions/checkout@v4
    with:
      token: ${{ steps.app-token.outputs.token }}
```

---

## Summary for Wish Implementation

To provision GitHub Apps for `declastruct-github` and `please-release`:

### Required Domain Objects:
1. **DeclaredGithubApp** - Entity representing the app configuration
2. **DeclaredGithubAppInstallation** - Entity representing where the app is installed

### Required Operations:
1. **createAppFromManifest** - Register new apps via manifest flow (manual/UI step)
2. **getInstallation** / **getOrgInstallation** - Find installation for an org
3. **createInstallationAccessToken** - Generate short-lived tokens

### Required Secrets Storage:
- `APP_ID` - GitHub App ID (as variable)
- `PRIVATE_KEY` - GitHub App private key (as secret)

### Workflow Integration:
Use `actions/create-github-app-token@v2` in workflows to get scoped tokens.

---

## Citations Index

1. [REST API endpoints for GitHub Apps](https://docs.github.com/en/rest/apps/apps) - App object properties
2. [@octokit/auth-app.js](https://github.com/octokit/auth-app.js) - createAppAuth parameters
3. [Registering a GitHub App from a manifest](https://docs.github.com/en/apps/sharing-github-apps/registering-a-github-app-from-a-manifest) - Manifest flow response
4. [REST API endpoints for GitHub App installations](https://docs.github.com/en/rest/apps/installations) - Installation object schema
5. [REST API endpoints for GitHub App installations](https://docs.github.com/en/rest/apps/installations) - Token expiration
6. [Webhook events and payloads](https://docs.github.com/en/webhooks/webhook-events-and-payloads) - installation event
7. [Webhook events and payloads](https://docs.github.com/en/webhooks/webhook-events-and-payloads) - installation_target event
8. [Webhook events and payloads](https://docs.github.com/en/webhooks/webhook-events-and-payloads) - github_app_authorization event
9. [Permissions required for GitHub Apps](https://docs.github.com/en/rest/authentication/permissions-required-for-github-apps) - Permission categories and levels
10. [Permissions required for GitHub Apps](https://docs.github.com/en/rest/authentication/permissions-required-for-github-apps) - Workflows permission
11. [Registering a GitHub App from a manifest](https://docs.github.com/en/apps/sharing-github-apps/registering-a-github-app-from-a-manifest) - Visibility parameter
12-23. [REST API endpoints for GitHub Apps](https://docs.github.com/en/rest/apps/apps) - Various endpoints
24-29. [REST API endpoints for GitHub App installations](https://docs.github.com/en/rest/apps/installations) - Installation endpoints
30-31. [@octokit/auth-app.js](https://github.com/octokit/auth-app.js) - SDK usage
32. [actions/create-github-app-token](https://github.com/actions/create-github-app-token) - GitHub Action
