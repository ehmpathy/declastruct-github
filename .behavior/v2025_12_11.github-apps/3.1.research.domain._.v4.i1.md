# Research: How Terraform Manages GitHub App Installations

## Question

How is Terraform able to manage GitHub App installations completely? Can we use the same API calls to make installation creation fully automated?

---

## Answer Summary

**Terraform CANNOT create GitHub App installations either.** It uses the exact same API endpoints we identified, which only manage **repository access** for installations that already exist.

The installation itself must be created manually by a user clicking "Install" in the GitHub UI.

---

## What Terraform Actually Does

### Resource: `github_app_installation_repository`

> [1] "This resource manages relationships between app installations and repositories in your GitHub organization. Creating this resource installs a particular app on a particular repository." - [Terraform Registry](https://registry.terraform.io/providers/integrations/github/latest/docs/resources/app_installation_repository)

**Misleading Documentation:** The phrase "installs a particular app" is misleading. It actually means "adds a repository to an app installation" - NOT creating a new installation.

### Required Input: `installation_id`

```hcl
resource "github_app_installation_repository" "some_app_repo" {
  # The installation id of the app (in the organization).
  installation_id = "1234567"  # <-- Must already exist!
  repository      = github_repository.some_repo.name
}
```

The `installation_id` is **required** - meaning the installation must already exist before Terraform can manage it.

---

## API Endpoints Used by Terraform

Terraform's `github_app_installation_repository` resource uses the `google/go-github` library, which calls:

### Add Repository to Installation
```http
PUT /user/installations/{installation_id}/repositories/{repository_id}
```

> [2] "AddRepository adds a single repository to an installation." - [go-github/apps_installation.go](https://github.com/google/go-github/blob/master/github/apps_installation.go)

### Remove Repository from Installation
```http
DELETE /user/installations/{installation_id}/repositories/{repository_id}
```

**These are the SAME endpoints we identified in our research.**

---

## What Terraform CANNOT Do

| Operation | Terraform Support | Why |
|-----------|------------------|-----|
| Create app installation | **NO** | No API exists |
| Read app installation | YES | `GET /app/installations/{id}` |
| Add repo to installation | YES | `PUT /user/installations/{id}/repositories/{repo_id}` |
| Remove repo from installation | YES | `DELETE /user/installations/{id}/repositories/{repo_id}` |
| Delete installation | YES | `DELETE /app/installations/{id}` |

---

## Terraform's Limitation

> [3] "Due to how GitHub implements app installations, apps cannot be installed with no repositories selected. Therefore deleting this resource will leave one repository with the app installed. You'll need to manually uninstall the app or set the installation to all repositories via the GUI after deleting this resource." - [Terraform Registry](https://registry.terraform.io/providers/integrations/github/latest/docs/resources/app_installation_repository)

This confirms:
1. Terraform cannot create installations
2. Terraform cannot fully delete installations (last repo cannot be removed)
3. Manual GUI intervention is still required

---

## Terraform Workflow for GitHub Apps

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Terraform GitHub App Workflow                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  1. MANUAL: User creates GitHub App in GitHub UI                    │
│     └─ Gets: app_id, private_key                                    │
│                                                                      │
│  2. MANUAL: User installs app on organization in GitHub UI          │
│     └─ Gets: installation_id                                        │
│                                                                      │
│  3. TERRAFORM: Configure provider with app credentials              │
│     provider "github" {                                             │
│       app_auth {                                                    │
│         id              = var.app_id                                │
│         installation_id = var.installation_id  # From step 2       │
│         pem_file        = var.pem_file                              │
│       }                                                             │
│     }                                                               │
│                                                                      │
│  4. TERRAFORM: Manage repos in installation                         │
│     resource "github_app_installation_repository" "repo" {          │
│       installation_id = var.installation_id                         │
│       repository      = "my-repo"                                   │
│     }                                                               │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Conclusion for declastruct-github

**Our analysis was correct.** There is no API to create GitHub App installations.

The best we can do (and what Terraform does) is:

1. **AUTOMATED:** Manage repository access for installations that already exist
2. **GENERATED:** Provide URLs and guidance for users to create installations manually
3. **AUTOMATED:** Delete installations via API (though not fully - last repo stays)

Our `setAppInstallation` design matches Terraform's capabilities:
- If installation doesn't exist: throw `HelpfulError` with installation URL
- If installation exists: automate repo add/remove

---

## Citations

1. [Terraform Registry - github_app_installation_repository](https://registry.terraform.io/providers/integrations/github/latest/docs/resources/app_installation_repository) - Resource documentation
2. [go-github/apps_installation.go](https://github.com/google/go-github/blob/master/github/apps_installation.go) - AddRepository function
3. [Terraform Registry - github_app_installation_repository](https://registry.terraform.io/providers/integrations/github/latest/docs/resources/app_installation_repository) - Deletion limitation
