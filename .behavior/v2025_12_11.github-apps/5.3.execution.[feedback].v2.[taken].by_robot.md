# Response to Feedback v2

## Response Checklist

### blocker.1: Verify cast can reliably get app info from API
- [x] Web search GitHub API installation response schema
- [x] Verify `app_slug` and `app.owner.login` are always present
- [x] Document findings
- [x] Fix: Installation response does NOT include `app.owner.login`, only `app_slug`
- [x] Solution: Pass app reference from caller for `by.unique`, lookup via `GET /apps/{app_slug}` for `by.primary`

### blocker.2: Can we upload manifest directly?
- [x] Researched - NO, manifest flow requires user approval on GitHub UI
- [x] Made `homepageUrl` required on `DeclaredGithubApp` (it's required for manifest)
- [x] Documented limitation in setApp.ts

### blocker.3: Add primary key to DeclaredGithubApp
- [x] Add `public static primary = ['id'] as const` to DeclaredGithubApp
- [x] Update getOneApp to support `by.primary` - NOT POSSIBLE
  - GitHub API doesn't provide endpoint to get app by numeric ID
  - Options: `GET /apps/{app_slug}` (needs slug) or `GET /app` (needs JWT auth)
  - Documented limitation in getOneApp.ts comment

---

## Execution Log

### blocker.1: Verify cast reliability

**Findings from GitHub API research:**
- Installation response includes: `app_id`, `app_slug`, `account`, `target_type`, etc.
- Installation response does **NOT** include `app.owner.login` - this was a bug in the original code
- To get app owner, must call `GET /apps/{app_slug}` which returns full app object with `owner.login`

**Fix applied:**
1. Updated `castToDeclaredGithubAppInstallation` to require `app: { owner, slug }` as input parameter
2. Updated `getOneAppInstallation`:
   - For `by.unique`: pass the known `app` from input
   - For `by.primary`: lookup app via `GET /apps/{app_slug}` to get owner

**Files changed:**
- `src/domain.operations/appInstallation/castToDeclaredGithubAppInstallation.ts`
- `src/domain.operations/appInstallation/getOneAppInstallation.ts`

### blocker.2: Manifest flow limitation

**Findings:**
- GitHub App Manifest flow requires user to visit GitHub and click "Create GitHub App"
- No way to fully automate - user approval is required
- `POST /app-manifests/{code}/conversions` exchanges code for credentials AFTER user approval

**Already done:**
- `homepageUrl` made required on `DeclaredGithubApp` (manifest requires `url` field)
- Removed undocumented `target_id` parameter from install URL

### blocker.3: Primary key for DeclaredGithubApp

**Changes:**
- Added `public static primary = ['id'] as const` to `DeclaredGithubApp`

**getOneApp by.primary - NOT SUPPORTED:**
- GitHub API has no endpoint to get app by numeric ID
- `GET /apps/{app_slug}` requires slug (not ID)
- `GET /app` requires JWT auth (authenticating as the app itself)
- Added note to `getOneApp.ts` documenting this limitation

---

## Test Results

All tests pass:
- Type checks: ✅
- Unit tests: ✅

Sources:
- [REST API endpoints for GitHub Apps](https://docs.github.com/en/rest/apps/apps)
- [REST API endpoints for GitHub App installations](https://docs.github.com/en/rest/apps/installations)
- [Mapping a GitHub App id into the App's name](https://github.com/orgs/community/discussions/24821)
