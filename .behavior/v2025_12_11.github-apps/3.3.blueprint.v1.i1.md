# Blueprint: GitHub Apps Implementation

## Overview

This blueprint describes how to implement GitHub App support for `declastruct-github`, enabling:
1. Declarative definition of GitHub Apps
2. Declarative management of App installations
3. Integration with `actions/create-github-app-token` for workflows

**Note:** Access token generation is intentionally excluded — tokens are ephemeral resources, not declarative constructs. Use `actions/create-github-app-token` in workflows for token generation.

---

## Phase 1: Domain Objects

### 1.1 No Changes to `ContextGithubApi.ts`

**The context stays as-is.** It just takes a `token`:
- Could be a PAT (Personal Access Token)
- Could be an installation token from `actions/create-github-app-token`

Both are bearer tokens that work identically with Octokit. No special "app auth" needed.

```typescript
// Unchanged - works with PAT or app installation token
export interface ContextGithubApi {
  github: {
    token: string;
  };
}
```

### 1.2 Create `DeclaredGithubAppPermissions.ts`

**Path:** `src/domain.objects/DeclaredGithubAppPermissions.ts`

**Pattern:** `DomainLiteral` for type-safe permission configuration

```typescript
export interface DeclaredGithubAppPermissions {
  // Repository permissions
  contents?: 'read' | 'write';
  pullRequests?: 'read' | 'write';
  issues?: 'read' | 'write';
  actions?: 'read' | 'write';
  // ... (see distill doc for full list)
}

export class DeclaredGithubAppPermissions
  extends DomainLiteral<DeclaredGithubAppPermissions>
  implements DeclaredGithubAppPermissions {}
```

### 1.3 Create `DeclaredGithubApp.ts`

**Path:** `src/domain.objects/DeclaredGithubApp.ts`

**Pattern:** Follow `DeclaredGithubRepo.ts`

```typescript
export interface DeclaredGithubApp {
  id?: number;
  createdAt?: UniDateTime;
  updatedAt?: UniDateTime;
  slug: string;
  owner: string;
  name?: string;
  description?: string;
  public?: boolean;
  permissions: DeclaredGithubAppPermissions;
  events?: string[];
  homepageUrl?: string;
  webhookUrl?: string;
}

export class DeclaredGithubApp
  extends DomainEntity<DeclaredGithubApp>
  implements DeclaredGithubApp
{
  public static unique = ['owner', 'slug'] as const;
}
```

### 1.4 Create `DeclaredGithubAppInstallation.ts`

**Path:** `src/domain.objects/DeclaredGithubAppInstallation.ts`

**Pattern:** Follow `DeclaredGithubBranch.ts` (nested reference to parent)

```typescript
export interface DeclaredGithubAppInstallation {
  id?: number;
  createdAt?: UniDateTime;
  updatedAt?: UniDateTime;
  app: RefByUnique<typeof DeclaredGithubApp>;
  targetType: 'Organization' | 'User';
  targetLogin: string;
  repositorySelection?: 'all' | 'selected';
  repositories?: string[];
  suspended?: boolean;
}

export class DeclaredGithubAppInstallation
  extends DomainEntity<DeclaredGithubAppInstallation>
  implements DeclaredGithubAppInstallation
{
  public static unique = ['app', 'targetType', 'targetLogin'] as const;
}
```

---

## Phase 2: SDK Client

### 2.1 No Changes to `getGithubClient.ts`

**The SDK client stays as-is.** It already works with any bearer token:

```typescript
// Unchanged - already works with PAT or app installation token
export const getGithubClient = withSimpleCache(
  (input: unknown, context: ContextGithubApi) =>
    new Octokit({ auth: context.github.token }),
  // ...
);
```

**No new dependencies needed.**

---

## Phase 3: Domain Operations

### 3.1 App Operations

#### `src/domain.operations/app/getOneApp.ts`

**Pattern:** Follow `getOneRepo.ts` — single-entity lookup

```
getOneApp({ by: { unique } }, context) → DeclaredGithubApp | null
```

- `by.unique`: `{ owner, slug }` → `GET /apps/{slug}` (public info, no auth required)

**Note:** `getAllApps` is not applicable — apps are owned resources, not queryable collections. `GET /app` (authenticated app info) requires App JWT, which is out of scope.

#### `src/domain.operations/app/setApp.ts`

**Pattern:** Follow `setRepo.ts` but throw `HelpfulError` for create/update

```
setApp({ finsert | upsert }, context) → DeclaredGithubApp | throws HelpfulError
```

- If `foundBefore && finsert`: return `foundBefore`
- If `foundBefore && upsert`: throw HelpfulError with settings URL
- If `!foundBefore`: throw HelpfulError with manifest + registration URL

#### `src/domain.operations/app/castToDeclaredGithubApp.ts`

**Pattern:** Follow `castToDeclaredGithubRepo.ts`

### 3.2 Installation Operations

#### `src/domain.operations/appInstallation/getOneAppInstallation.ts`

**Pattern:** Follow `getOneBranch.ts` — single-entity lookup

```
getOneAppInstallation({ by: { unique } | { org } | { user } | { repo } }, context) → DeclaredGithubAppInstallation | null
```

- `by.unique`: `{ app, targetType, targetLogin }` → resolves to `by.org` or `by.user` based on `targetType`
- `by.org`: `{ org }` → `GET /orgs/{org}/installation` (requires PAT with org admin)
- `by.user`: `{ user }` → `GET /users/{username}/installation` (requires PAT with user access)
- `by.repo`: `{ owner, repo }` → `GET /repos/{owner}/{repo}/installation` (requires PAT with repo admin)

**Note:** `getAllAppInstallations` is out of scope — `GET /app/installations` requires App JWT.

#### `src/domain.operations/appInstallation/setAppInstallation.ts`

**Pattern:** Follow `setBranch.ts` but with partial automation

```
setAppInstallation({ finsert | upsert }, context)
```

- If `!foundBefore`: throw HelpfulError with installation URL
- If `foundBefore && upsert && repositorySelection === 'selected'`:
  - AUTOMATED: Add/remove repos via API
- Return updated installation

#### `src/domain.operations/appInstallation/deleteAppInstallation.ts`

**Pattern:** Throw HelpfulError (requires App JWT)

```
deleteAppInstallation({ installation }, context) → throws HelpfulError
```

- `DELETE /app/installations/{id}` requires App JWT
- Throw HelpfulError with URL to uninstall via GitHub UI

#### `src/domain.operations/appInstallation/castToDeclaredGithubAppInstallation.ts`

**Pattern:** Follow `castToDeclaredGithubBranch.ts`

---

## Phase 4: Access DAOs

### 4.1 Create `DeclaredGithubAppDao.ts`

**Path:** `src/access/daos/DeclaredGithubAppDao.ts`

**Pattern:** Follow `DeclaredGithubRepoDao.ts`

```typescript
export const DeclaredGithubAppDao = genDeclastructDao<
  typeof DeclaredGithubApp,
  ContextGithubApi & ContextLogTrail
>({
  dobj: DeclaredGithubApp,
  get: {
    one: {
      byUnique: (input, ctx) => getOneApp({ by: { unique: input } }, ctx),
      byPrimary: null,
    },
  },
  set: {
    finsert: (input, ctx) => setApp({ finsert: input }, ctx),
    upsert: (input, ctx) => setApp({ upsert: input }, ctx),
    delete: (input) => /* throw HelpfulError with deletion URL */,
  },
});
```

### 4.2 Create `DeclaredGithubAppInstallationDao.ts`

**Path:** `src/access/daos/DeclaredGithubAppInstallationDao.ts`

**Pattern:** Follow `DeclaredGithubBranchDao.ts`

```typescript
export const DeclaredGithubAppInstallationDao = genDeclastructDao<
  typeof DeclaredGithubAppInstallation,
  ContextGithubApi & ContextLogTrail
>({
  dobj: DeclaredGithubAppInstallation,
  get: {
    one: {
      byUnique: (input, ctx) => getOneAppInstallation({ by: { unique: input } }, ctx),
      byPrimary: null, // GET /app/installations/{id} requires App JWT
    },
  },
  set: {
    finsert: (input, ctx) => setAppInstallation({ finsert: input }, ctx),
    upsert: (input, ctx) => setAppInstallation({ upsert: input }, ctx),
    delete: (input, ctx) => deleteAppInstallation({ installation: input }, ctx), // throws HelpfulError
  },
});
```

---

## Phase 5: Provider Integration

### 5.1 Update `DeclastructGithubProvider.ts`

**Path:** `src/domain.objects/DeclastructGithubProvider.ts`

Add new DAO types to the provider type definition.

### 5.2 Update `getDeclastructGithubProvider.ts`

**Path:** `src/domain.operations/provider/getDeclastructGithubProvider.ts`

**Changes:**
1. Wire up new DAOs (DeclaredGithubAppDao, DeclaredGithubAppInstallationDao)
2. No auth changes needed — existing `{ token }` works with both PATs and installation tokens

```typescript
export const getDeclastructGithubProvider = (
  input: {
    credentials: { token: string };
  },
  context: ContextLogTrail,
): DeclastructGithubProvider => {
  // Assemble all DAOs including new app DAOs
  // Return provider
};
```

### 5.3 Update `src/contract/sdks/index.ts`

Export new domain objects:
- `DeclaredGithubApp`
- `DeclaredGithubAppPermissions`
- `DeclaredGithubAppInstallation`

---

## Phase 6: Testing

### 6.1 Unit Tests

| File                         | Tests                                                  |
| ---------------------------- | ------------------------------------------------------ |
| `setApp.test.ts`             | Manifest generation, HelpfulError content              |
| `setAppInstallation.test.ts` | HelpfulError for missing installation, repo sync logic |

### 6.2 Integration Tests

| File                                        | Tests                    |
| ------------------------------------------- | ------------------------ |
| `getOneApp.integration.test.ts`             | Read app by slug         |
| `getOneAppInstallation.integration.test.ts` | Read installation by org |

**Note:** Integration tests require a GitHub token (PAT or installation token) with appropriate permissions.

### 6.3 Acceptance Tests

**Use Case:** Declare a `declastruct-github-demo-app` GitHub App for acceptance testing.

#### `src/contract/sdks/.test/assets/resources.apps.acceptance.ts`

```typescript
import { UnexpectedCodePathError } from 'helpful-errors';

import {
  DeclaredGithubApp,
  DeclaredGithubAppInstallation,
  getDeclastructGithubProvider,
} from '../../../../../dist/contract/sdks';

/**
 * .what = provider configuration for GitHub Apps acceptance tests
 * .why = enables declastruct CLI to interact with GitHub API
 */
export const getProviders = async () => [
  getDeclastructGithubProvider(
    {
      credentials: {
        token:
          process.env.GITHUB_TOKEN ??
          UnexpectedCodePathError.throw('github token not supplied'),
      },
    },
    {
      log: {
        info: () => {},
        debug: () => {},
        warn: console.warn,
        error: console.error,
      },
    },
  ),
];

/**
 * .what = resource declarations for GitHub Apps acceptance tests
 * .why = defines desired state of demo app for testing declastruct-github
 */
export const getResources = async () => {
  // declare the demo app for acceptance testing
  const demoApp = DeclaredGithubApp.as({
    owner: 'ehmpathy',
    slug: 'declastruct-github-demo-app',
    name: 'Declastruct GitHub Demo App',
    description: 'Demo GitHub App for declastruct-github acceptance tests',
    public: false,
    permissions: {
      contents: 'read',
      metadata: 'read',
    },
    events: [],
  });

  // declare installation on ehmpathy org
  const demoInstallation = DeclaredGithubAppInstallation.as({
    app: { owner: demoApp.owner, slug: demoApp.slug },
    targetType: 'Organization',
    targetLogin: 'ehmpathy',
    repositorySelection: 'selected',
    repositories: ['declastruct-github-demo'],
  });

  return [demoApp, demoInstallation];
};
```

#### `src/contract/sdks/declastruct.apps.acceptance.test.ts`

```typescript
import { execSync } from 'child_process';
import type { DeclastructChange } from 'declastruct';
import { existsSync, mkdirSync, readFileSync } from 'fs';
import { join } from 'path';
import { given, then, when } from 'test-fns';

/**
 * .what = acceptance tests for GitHub Apps declastruct workflow
 * .why = validates plan + apply work (either HelpfulError or KEEP)
 */
describe('declastruct GitHub Apps workflow', () => {
  given('a declastruct resources file with GitHub App declarations', () => {
    const testDir = join(__dirname, '.test', '.temp', 'acceptance.apps', `run.${new Date().toISOString()}`);
    const resourcesFile = join(__dirname, '.test', 'assets', 'resources.apps.acceptance.ts');
    const planFile = join(testDir, 'plan.json');

    beforeEach(() => {
      mkdirSync(testDir, { recursive: true });
    });

    when('running plan + apply', () => {
      then('plan succeeds with app and installation resources', async () => {
        // plan
        execSync(`npx declastruct plan --wish ${resourcesFile} --into ${planFile}`, {
          stdio: 'inherit',
          env: process.env,
        });

        // verify plan
        expect(existsSync(planFile)).toBe(true);
        const plan = JSON.parse(readFileSync(planFile, 'utf-8'));
        const appChange: DeclastructChange = plan.changes.find(
          (c: DeclastructChange) => c.forResource.class === 'DeclaredGithubApp',
        );
        const installChange: DeclastructChange = plan.changes.find(
          (c: DeclastructChange) => c.forResource.class === 'DeclaredGithubAppInstallation',
        );
        expect(appChange).toBeDefined();
        expect(installChange).toBeDefined();
      });

      then('apply succeeds (KEEP) or throws HelpfulError with guidance', async () => {
        // plan
        execSync(`npx declastruct plan --wish ${resourcesFile} --into ${planFile}`, {
          stdio: 'inherit',
          env: process.env,
        });

        // apply - either succeeds (KEEP) or throws HelpfulError
        try {
          execSync(`npx declastruct apply --plan ${planFile}`, {
            stdio: 'inherit',
            env: process.env,
          });
          // success = resources already exist (KEEP)
        } catch (error: any) {
          // expected = HelpfulError with guidance URL
          const output = error.stdout?.toString() + error.stderr?.toString();
          expect(output).toMatch(/github\.com.*(settings\/apps|installations)/i);
        }
      });
    });
  });
});
```

---

## Phase 7: Documentation & Examples

### 7.1 Workflow Example

Create example workflow demonstrating `actions/create-github-app-token`:

**Path:** `examples/workflows/github-app-token.yml`

```yaml
jobs:
  example:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.DECLASTRUCT_GITHUB_APP_ID }}
          private-key: ${{ secrets.DECLASTRUCT_GITHUB_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}

      - run: npx declastruct apply --plan plan.json
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
```

### 7.2 Resources Example

Create example resources file showing app declarations:

**Path:** `examples/resources/github-apps.ts`

```typescript
export const getResources = async () => {
  const app = DeclaredGithubApp.as({
    slug: 'declastruct-github',
    owner: 'ehmpathy',
    permissions: {
      contents: 'write',
      pullRequests: 'write',
      metadata: 'read',
    },
    events: ['push', 'pull_request'],
  });

  const installation = DeclaredGithubAppInstallation.as({
    app,
    targetType: 'Organization',
    targetLogin: 'ehmpathy',
    repositorySelection: 'selected',
    repositories: ['declastruct-github'],
  });

  return [app, installation];
};
```

---

## File Creation Order

### Batch 1: Domain Objects
1. `src/domain.objects/DeclaredGithubAppPermissions.ts`
2. `src/domain.objects/DeclaredGithubApp.ts`
3. `src/domain.objects/DeclaredGithubAppInstallation.ts`

**Note:** No changes to `ContextGithubApi.ts` or `getGithubClient.ts` - they already work with any bearer token (PAT or app installation token).

### Batch 2: Cast Functions
4. `src/domain.operations/app/castToDeclaredGithubApp.ts`
5. `src/domain.operations/appInstallation/castToDeclaredGithubAppInstallation.ts`

### Batch 3: Read Operations
6. `src/domain.operations/app/getOneApp.ts`
7. `src/domain.operations/appInstallation/getOneAppInstallation.ts`

### Batch 4: Write Operations
8. `src/domain.operations/app/setApp.ts`
9. `src/domain.operations/appInstallation/setAppInstallation.ts`
10. `src/domain.operations/appInstallation/deleteAppInstallation.ts`

### Batch 5: DAOs
11. `src/access/daos/DeclaredGithubAppDao.ts`
12. `src/access/daos/DeclaredGithubAppInstallationDao.ts`

### Batch 6: Provider Integration
13. Update `src/domain.objects/DeclastructGithubProvider.ts`
14. Update `src/domain.operations/provider/getDeclastructGithubProvider.ts`
15. Update `src/contract/sdks/index.ts`

### Batch 7: Tests
16. Unit tests for new operations (setApp.test.ts, setAppInstallation.test.ts)
17. Integration tests (getOneApp.integration.test.ts, getOneAppInstallation.integration.test.ts)

### Batch 8: Examples
18. `examples/workflows/github-app-token.yml`
19. `examples/resources/github-apps.ts`

---

## Dependencies

### New NPM Dependencies

**None.** The existing `@octokit/rest` already works with installation tokens.

### Environment Variables (for testing)

```bash
# Use actions/create-github-app-token in CI, or manually create a token for local testing
GITHUB_TOKEN=ghs_xxxxxxxxxxxx  # Installation token from GitHub App
```

**Note:** For local testing, you can:
1. Create a fine-grained PAT with appropriate permissions, OR
2. Use the GitHub CLI: `gh auth token` (if your CLI is authenticated via a GitHub App)

---

## Automation Boundaries Reminder

| Operation                            | Automated         | Manual (HelpfulError) |
| ------------------------------------ | ----------------- | --------------------- |
| Read app (by slug)                   | YES               | -                     |
| Create app                           | Generate manifest | Browser confirmation  |
| Update app                           | -                 | All via UI            |
| Delete app                           | -                 | All via UI            |
| Read installation (by org/user/repo) | YES               | -                     |
| Create installation                  | -                 | Click "Install"       |
| Update installation (repos)          | YES               | -                     |
| Delete installation                  | -                 | Requires App JWT → UI |

**Notes:**
- Access token generation is out of scope — tokens are ephemeral, not declarative resources. Use `actions/create-github-app-token` in workflows.
- Operations requiring App JWT (`GET /app`, `GET /app/installations`, `DELETE /app/installations/{id}`) are out of scope — use PAT-accessible endpoints only.

---

## Phase 8: Provision Files (Wish Fulfillment)

These files fulfill the original wish: creating GitHub Apps for `declastruct-github` and `please-release`.

### 8.1 `provision/github.apps/resources.ts`

**Purpose:** Main entry point that composes all app resources with shared provider

```typescript
import { DeclastructProvider } from 'declastruct';
import { DomainEntity } from 'domain-objects';
import { UnexpectedCodePathError } from 'helpful-errors';

import { getDeclastructGithubProvider } from '../../dist/contract/sdks';

import { getResourcesOfAppDeclastructGithub } from './resources.app.declastruct-github';
import { getResourcesOfAppPleaseRelease } from './resources.app.please-release';

/**
 * .what = provider configuration for github apps provisioning
 * .why = enables declastruct CLI to interact with GitHub API
 */
export const getProviders = async (): Promise<DeclastructProvider[]> => [
  getDeclastructGithubProvider(
    {
      credentials: {
        token:
          process.env.GITHUB_TOKEN ??
          UnexpectedCodePathError.throw('github token not supplied'),
      },
    },
    {
      log: {
        info: () => {},
        debug: () => {},
        warn: console.warn,
        error: console.error,
      },
    },
  ),
];

/**
 * .what = composes all github app resources
 * .why = single entry point for provisioning all ehmpathy github apps
 */
export const getResources = async (): Promise<DomainEntity<any>[]> => [
  ...(await getResourcesOfAppDeclastructGithub()),
  ...(await getResourcesOfAppPleaseRelease()),
];
```

### 8.2 `provision/github.apps/resources.app.declastruct-github.ts`

**Purpose:** App with permissions to manage repos (for `provision/github/declastruct.resources.ts`)

```typescript
import { DomainEntity } from 'domain-objects';

import {
  DeclaredGithubApp,
  DeclaredGithubAppInstallation,
} from '../../dist/contract/sdks';

/**
 * .what = declares the declastruct-github app and its installation
 * .why = enables short-lived, scoped tokens for repo management operations
 */
export const getResourcesOfAppDeclastructGithub = async (): Promise<DomainEntity<any>[]> => {
  // declare the app with repo management permissions
  const app = DeclaredGithubApp.as({
    owner: 'ehmpathy',
    slug: 'declastruct-github',
    name: 'Declastruct GitHub',
    description: 'Control GitHub resources with declarative instructions via declastruct-github',
    public: false,
    permissions: {
      // repo management (create, update settings)
      administration: 'write',
      // repo contents (for branch operations)
      contents: 'write',
      // metadata (required for most operations)
      metadata: 'read',
    },
    events: [],
  });

  // declare installation on ehmpathy org
  const installation = DeclaredGithubAppInstallation.as({
    app: { owner: app.owner, slug: app.slug },
    targetType: 'Organization',
    targetLogin: 'ehmpathy',
    repositorySelection: 'all', // needs access to all repos it manages
  });

  return [app, installation];
};
```

### 8.3 `provision/github.apps/resources.app.please-release.ts`

**Purpose:** App with permissions to read/write PRs and commits (for `.github/workflows/release.yml`)

```typescript
import { DomainEntity } from 'domain-objects';

import {
  DeclaredGithubApp,
  DeclaredGithubAppInstallation,
} from '../../dist/contract/sdks';

/**
 * .what = declares the please-release app and its installation
 * .why = enables short-lived, scoped tokens for release-please workflow
 *
 * .note = release-please needs:
 *   - contents: write (create release commits, update changelog)
 *   - pull_requests: write (create/update release PRs)
 */
export const getResourcesOfAppPleaseRelease = async (): Promise<DomainEntity<any>[]> => {
  // declare the app with release workflow permissions
  const app = DeclaredGithubApp.as({
    owner: 'ehmpathy',
    slug: 'please-release',
    name: 'Please Release',
    description: 'Automates releases via release-please',
    public: false,
    permissions: {
      // push release commits, update changelog
      contents: 'write',
      // create and update release PRs
      pullRequests: 'write',
      // required for most operations
      metadata: 'read',
    },
    events: [],
  });

  // declare installation on ehmpathy org
  const installation = DeclaredGithubAppInstallation.as({
    app: { owner: app.owner, slug: app.slug },
    targetType: 'Organization',
    targetLogin: 'ehmpathy',
    repositorySelection: 'all', // release-please runs on all repos
  });

  return [app, installation];
};
```

### 8.4 Update `provision/github.apps/readme.md`

```markdown
this dir houses the declared github apps used by the ehmpathy org

we collocate them within this repo to demonstrate how these resources can be used && to dogfood our releases

## structure

- `resources.ts` - main entry point, composes all apps
- `resources.app.declastruct-github.ts` - repo management permissions (administration, contents)
- `resources.app.please-release.ts` - release workflow permissions (contents, pullRequests)

## usage

```bash
# plan all apps at once
npx declastruct plan --wish provision/github.apps/resources.app.declastruct-github.ts --into provision/github.apps/.temp/plan.json

# apply changes (will throw HelpfulError with setup URLs if app doesn't exist)
npx declastruct apply --plan provision/github.apps/.temp/plan.json
```

## workflow integration

once apps are created, use `actions/create-github-app-token` in workflows:

```yaml
- uses: actions/create-github-app-token@v2
  id: app-token
  with:
    app-id: ${{ vars.DECLASTRUCT_GITHUB_APP_ID }}
    private-key: ${{ secrets.DECLASTRUCT_GITHUB_APP_PRIVATE_KEY }}
    owner: ${{ github.repository_owner }}

- run: npx declastruct apply --plan plan.json
  env:
    GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
```

---

## File Creation Order (Updated)

### Batch 1: Domain Objects
1. `src/domain.objects/DeclaredGithubAppPermissions.ts`
2. `src/domain.objects/DeclaredGithubApp.ts`
3. `src/domain.objects/DeclaredGithubAppInstallation.ts`

**Note:** No changes to `ContextGithubApi.ts` or `getGithubClient.ts` - they already work with any bearer token (PAT or app installation token).

### Batch 2: Cast Functions
4. `src/domain.operations/app/castToDeclaredGithubApp.ts`
5. `src/domain.operations/appInstallation/castToDeclaredGithubAppInstallation.ts`

### Batch 3: Read Operations
6. `src/domain.operations/app/getOneApp.ts`
7. `src/domain.operations/appInstallation/getOneAppInstallation.ts`

### Batch 4: Write Operations
8. `src/domain.operations/app/setApp.ts`
9. `src/domain.operations/appInstallation/setAppInstallation.ts`
10. `src/domain.operations/appInstallation/deleteAppInstallation.ts`

### Batch 5: DAOs
11. `src/access/daos/DeclaredGithubAppDao.ts`
12. `src/access/daos/DeclaredGithubAppInstallationDao.ts`

### Batch 6: Provider Integration
13. Update `src/domain.objects/DeclastructGithubProvider.ts`
14. Update `src/domain.operations/provider/getDeclastructGithubProvider.ts`
15. Update `src/contract/sdks/index.ts`

### Batch 7: Tests
16. Unit tests for new operations (setApp.test.ts, setAppInstallation.test.ts)
17. Integration tests (getOneApp.integration.test.ts, getOneAppInstallation.integration.test.ts)

### Batch 8: Examples
18. `examples/workflows/github-app-token.yml`
19. `examples/resources/github-apps.ts`

### Batch 9: Provision Files (Wish Fulfillment)
20. `provision/github.apps/resources.app.declastruct-github.ts`
21. `provision/github.apps/resources.app.please-release.ts`
22. `provision/github.apps/resources.ts` (composes the above)
23. Update `provision/github.apps/readme.md`

### Batch 10: Workflow Updates
24. Update `.github/workflows/provision.yml` to use app token

---

## Phase 9: Workflow Integration

### 9.1 Update `.github/workflows/provision.yml`

**Current:** Uses PAT via `secrets.PROVISION_GITHUB_GITHUB_TOKEN`

**After:** Generate app token and pass as `github-token` (no changes to `.declastruct.yml` needed)

```yaml
name: provision

on:
  push:
    tags:
      - v*
    branches:
      - "main"
      - "master"
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }} # per [workflow] x [branch, tag]
  cancel-in-progress: true # cancel workflows for non-latest commits

jobs:
  # generate tokens for auth
  tokens:
    runs-on: ubuntu-latest
    outputs:
      github-token: ${{ steps.github-app-token.outputs.token }}
    steps:
      - uses: actions/create-github-app-token@v2
        id: github-app-token
        with:
          app-id: ${{ vars.DECLASTRUCT_GITHUB_APP_ID }}
          private-key: ${{ secrets.DECLASTRUCT_GITHUB_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

  # pass tokens to reusable workflow
  github:
    needs: [tokens]
    uses: ./.github/workflows/.declastruct.yml
    with:
      wish-path: provision/github/declastruct.resources.ts
      github-environment: prod
    secrets:
      github-token: ${{ needs.tokens.outputs.github-token }}
```

**Note:** `.declastruct.yml` remains unchanged — it already accepts `github-token` which works with both PATs and app installation tokens.

### 9.2 Required Org Configuration

After creating the `declastruct-github` app, configure:

**Organization Variables:**
- `DECLASTRUCT_GITHUB_APP_ID` - the app ID from GitHub App settings

**Organization Secrets:**
- `DECLASTRUCT_GITHUB_APP_PRIVATE_KEY` - the private key PEM file contents

### 9.3 Migration Path

1. Create the `declastruct-github` app (via declastruct or manually)
2. Install the app on the org
3. Add org variable `DECLASTRUCT_GITHUB_APP_ID`
4. Add org secret `DECLASTRUCT_GITHUB_APP_PRIVATE_KEY`
5. Update `provision.yml` to generate app token and pass as `github-token`
6. Remove legacy `PROVISION_GITHUB_GITHUB_TOKEN` secret (after verification)

---

## Success Criteria

1. **Declarative App Definition:** Users can declare `DeclaredGithubApp` with permissions/events
2. **Helpful Errors:** When automation isn't possible, provide actionable URLs
3. **Installation Repo Management:** Automatically sync repos for installations that already exist
4. **Workflow Integration:** Example workflow using `actions/create-github-app-token`
5. **Pattern Consistency:** All code follows patterns in the repo (`asProcedure`, `HelpfulError`, etc.)
6. **Wish Fulfilled:** `declastruct-github` and `please-release` apps declared and provisionable
