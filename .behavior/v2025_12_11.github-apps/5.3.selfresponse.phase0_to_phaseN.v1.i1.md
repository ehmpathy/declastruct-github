# Self-Response: GitHub Apps Implementation

tracking resolution of issues from self-review

---

## Resolution Summary

| issue | status | action |
|-------|--------|--------|
| B1 | ✅ resolved | added `.nested` to `DeclaredGithubApp` |
| B2 | ✅ resolved | added return type to `getResourcesOfAppDeclastructGithub` |
| B3 | ✅ resolved | added return type to `getResourcesOfAppPleaseRelease` |
| N1 | ✅ resolved | simplified IIFE to early return pattern |
| N2 | ✅ resolved | `DomainEntity` import added with B2/B3 fixes |
| N3 | n/a | acceptable per review notes |
| N4 | ✅ resolved | added test for deleteAppInstallation |

---

## B1: Added `.nested` to `DeclaredGithubApp`

**file:** `src/domain.objects/DeclaredGithubApp.ts`

**changes:**
1. changed `import type { DeclaredGithubAppPermissions }` to `import { DeclaredGithubAppPermissions }` (needed as value, not just type)
2. added `public static nested = { permissions: DeclaredGithubAppPermissions };`

**before:**
```ts
export class DeclaredGithubApp
  extends DomainEntity<DeclaredGithubApp>
  implements DeclaredGithubApp
{
  public static unique = ['owner', 'slug'] as const;
}
```

**after:**
```ts
export class DeclaredGithubApp
  extends DomainEntity<DeclaredGithubApp>
  implements DeclaredGithubApp
{
  public static unique = ['owner', 'slug'] as const;
  public static nested = { permissions: DeclaredGithubAppPermissions };
}
```

---

## B2/B3: Added Return Types to Provision Resource Functions

**files:**
- `provision/github.apps/resources.app.declastruct-github.ts`
- `provision/github.apps/resources.app.please-release.ts`

**changes:**
1. added `import { DeclaredResource } from 'declastruct';`
2. added explicit return type `Promise<DeclaredResource[]>`
3. changed import path from `../../dist/contract/sdks` to `../../src/contract/sdks`

**before:**
```ts
import { ... } from '../../dist/contract/sdks';
export const getResourcesOfAppDeclastructGithub = async () => {
```

**after:**
```ts
import { DeclaredResource } from 'declastruct';
import { ... } from '../../src/contract/sdks';
export const getResourcesOfAppDeclastructGithub = async (): Promise<
  DeclaredResource[]
> => {
```

---

## N1: Simplified IIFE in `getOneApp.ts`

**file:** `src/domain.operations/app/getOneApp.ts`

**before:**
```ts
const { slug } = (() => {
  if (input.by.unique) return { slug: input.by.unique.slug };

  UnexpectedCodePathError.throw('not referenced by unique. how not?', {
    input,
  });
})();
```

**after:**
```ts
if (!input.by.unique)
  UnexpectedCodePathError.throw('not referenced by unique. how not?', {
    input,
  });
const { slug } = input.by.unique;
```

---

## N4: Added Test for `deleteAppInstallation`

**file:** `src/domain.operations/appInstallation/deleteAppInstallation.test.ts`

**tests added:**
- organization installation: verifies HelpfulError with org uninstall URL
- user installation: verifies HelpfulError with user uninstall URL

---

## Additional: Updated DAOs for declastruct upgrade

**files:** all `src/access/daos/*.ts`

**change:** replaced `null` with `undefined` for unimplemented DAO methods (declastruct interface change)

---

## Verification

- ✅ `npm run test:types` passes
- ✅ `npm run test:unit` passes (14 tests)
