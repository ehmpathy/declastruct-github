# Roadmap: GitHub Organization Privileges Implementation

## Prerequisites

- [ ] **0.1** Ensure GITHUB_TOKEN environment variable is set with `admin:org` scope
  - **Acceptance:** Token can read org settings via `gh api /orgs/ehmpathy`
  - **Verify:** `gh api /orgs/ehmpathy | jq '.login'` returns `"ehmpathy"`

- [ ] **0.2** Install libsodium-wrappers dependency
  - **Depends on:** Nothing
  - **Acceptance:** Package is installed and types are available
  - **Verify:** `pnpm add libsodium-wrappers && pnpm add -D @types/libsodium-wrappers && npm run test:types`

---

## Phase 1: Domain Objects

### 1.1 DeclaredGithubOrg

- [ ] **1.1.1** Create `src/domain.objects/DeclaredGithubOrg.ts`
  - **Depends on:** Nothing
  - **Acceptance:** File exports `DeclaredGithubOrg` class with:
    - Interface with `id?`, `createdAt?`, `updatedAt?`, `login`, `name`, `description`, `billingEmail`, `twoFactorRequirementEnabled?`, `publicRepos?`
    - Class extends `DomainEntity`
    - Static `primary = ['id']`, `unique = ['login']`, `readonly = ['twoFactorRequirementEnabled', 'publicRepos']`
  - **Verify:** `npm run test:types`

### 1.2 DeclaredGithubOrgMemberPrivileges

- [ ] **1.2.1** Create `src/domain.objects/DeclaredGithubOrgMemberPrivileges.ts`
  - **Depends on:** 1.1.1
  - **Acceptance:** File exports `DeclaredGithubOrgMemberPrivileges` class with:
    - Interface with `updatedAt?`, `org: RefByUnique<typeof DeclaredGithubOrg>`, and all member privilege booleans
    - Key fields: `membersCanDeleteRepositories`, `membersCanChangeRepoVisibility`
    - Class extends `DomainEntity`
    - Static `unique = ['org']`, `readonly = ['updatedAt']`, `nested = { org: RefByUnique<typeof DeclaredGithubOrg> }`
  - **Verify:** `npm run test:types`

### 1.3 DeclaredGithubOrgVariable

- [ ] **1.3.1** Create `src/domain.objects/DeclaredGithubOrgVariable.ts`
  - **Depends on:** 1.1.1
  - **Acceptance:** File exports `DeclaredGithubOrgVariable` class with:
    - Interface with `org`, `name`, `value`, `visibility`, `selectedRepositoryNames?`, `createdAt?`, `updatedAt?`
    - Static `unique = ['org', 'name']`, `readonly = ['createdAt', 'updatedAt']`, `nested`
  - **Verify:** `npm run test:types`

### 1.4 DeclaredGithubOrgSecret

- [ ] **1.4.1** Create `src/domain.objects/DeclaredGithubOrgSecret.ts`
  - **Depends on:** 1.1.1
  - **Acceptance:** File exports `DeclaredGithubOrgSecret` class with:
    - Interface with `org`, `name`, `value?` (write-only), `visibility`, `selectedRepositoryNames?`, `createdAt?`, `updatedAt?`
    - Static `unique = ['org', 'name']`, `readonly = ['createdAt', 'updatedAt']`, `writeonly = ['value']`, `nested`
  - **Verify:** `npm run test:types`

### Phase 1 Checkpoint

- [ ] **1.5** All domain objects compile without errors
  - **Verify:** `npm run test:types && npm run test:format && npm run test:lint`

---

## Phase 2: Cast Functions

### 2.1 Organization Cast

- [ ] **2.1.1** Create `src/domain.operations/org/castToDeclaredGithubOrg.ts`
  - **Depends on:** 1.1.1
  - **Acceptance:** Function `castToDeclaredGithubOrg({ data })` transforms GitHub org API response to `DeclaredGithubOrg`
  - **Verify:** `npm run test:types`

### 2.2 Member Privileges Cast

- [ ] **2.2.1** Create `src/domain.operations/orgMemberPrivileges/castToDeclaredGithubOrgMemberPrivileges.ts`
  - **Depends on:** 1.2.1
  - **Acceptance:** Function `castToDeclaredGithubOrgMemberPrivileges({ data, org })` extracts member privilege fields from org API response
  - **Verify:** `npm run test:types`

### 2.3 Variable Cast

- [ ] **2.3.1** Create `src/domain.operations/orgVariable/castToDeclaredGithubOrgVariable.ts`
  - **Depends on:** 1.3.1
  - **Acceptance:** Function `castToDeclaredGithubOrgVariable({ data, org })` transforms variable API response
  - **Verify:** `npm run test:types`

### 2.4 Secret Cast

- [ ] **2.4.1** Create `src/domain.operations/orgSecret/castToDeclaredGithubOrgSecret.ts`
  - **Depends on:** 1.4.1
  - **Acceptance:** Function `castToDeclaredGithubOrgSecret({ data, org })` transforms secret metadata API response (no value)
  - **Verify:** `npm run test:types`

### Phase 2 Checkpoint

- [ ] **2.5** All cast functions compile without errors
  - **Verify:** `npm run test:types && npm run test:format && npm run test:lint`

---

## Phase 3: Domain Operations

### 3.1 Organization Operations

- [ ] **3.1.1** Create `src/domain.operations/org/getOneOrg.ts`
  - **Depends on:** 2.1.1
  - **Acceptance:** Function `getOneOrg({ by: { unique: { login } } }, context)` returns org or null
  - **Verify:** `npm run test:types`

- [ ] **3.1.2** Create `src/domain.operations/org/getOneOrg.integration.test.ts`
  - **Depends on:** 3.1.1
  - **Acceptance:** Test gets `ehmpathy` org and verifies login matches
  - **Verify:** `npm run test:integration -- --testPathPattern=getOneOrg`

- [ ] **3.1.3** Create `src/domain.operations/org/setOrg.ts`
  - **Depends on:** 3.1.1
  - **Acceptance:** Function `setOrg({ upsert: ... }, context)` updates org profile; throws if org doesn't exist (cannot create)
  - **Verify:** `npm run test:types`

### 3.2 Member Privileges Operations

- [ ] **3.2.1** Create `src/domain.operations/orgMemberPrivileges/getOneOrgMemberPrivileges.ts`
  - **Depends on:** 2.2.1
  - **Acceptance:** Function `getOneOrgMemberPrivileges({ by: { unique: { org } } }, context)` returns member privileges
  - **Verify:** `npm run test:types`

- [ ] **3.2.2** Create `src/domain.operations/orgMemberPrivileges/getOneOrgMemberPrivileges.integration.test.ts`
  - **Depends on:** 3.2.1
  - **Acceptance:** Test gets `ehmpathy` org member privileges and verifies `membersCanDeleteRepositories` is defined
  - **Verify:** `npm run test:integration -- --testPathPattern=getOneOrgMemberPrivileges`

- [ ] **3.2.3** Create `src/domain.operations/orgMemberPrivileges/setOrgMemberPrivileges.ts`
  - **Depends on:** 3.2.1
  - **Acceptance:** Function `setOrgMemberPrivileges({ upsert: ... }, context)` updates member privilege settings
  - **Verify:** `npm run test:types`

- [ ] **3.2.4** Create `src/domain.operations/orgMemberPrivileges/setOrgMemberPrivileges.test.ts`
  - **Depends on:** 3.2.3
  - **Acceptance:** Unit test verifies findsert returns existing, upsert calls API
  - **Verify:** `npm run test:unit -- --testPathPattern=setOrgMemberPrivileges`

### 3.3 Helper Operations

- [ ] **3.3.1** Create `src/domain.operations/repo/getRepoIdsByNames.ts`
  - **Depends on:** Nothing (uses existing getRepo)
  - **Acceptance:** Function `getRepoIdsByNames({ org, names }, context)` returns array of repo IDs
  - **Verify:** `npm run test:types`

### 3.4 Variable Operations

- [ ] **3.4.1** Create `src/domain.operations/orgVariable/getOneOrgVariable.ts`
  - **Depends on:** 2.3.1
  - **Acceptance:** Function `getOneOrgVariable({ by: { unique: { org, name } } }, context)` returns variable or null
  - **Verify:** `npm run test:types`

- [ ] **3.4.2** Create `src/domain.operations/orgVariable/getAllOrgVariables.ts`
  - **Depends on:** 2.3.1
  - **Acceptance:** Function `getAllOrgVariables({ org }, context)` returns array of variables
  - **Verify:** `npm run test:types`

- [ ] **3.4.3** Create `src/domain.operations/orgVariable/setOrgVariable.ts`
  - **Depends on:** 3.4.1, 3.3.1
  - **Acceptance:** Function `setOrgVariable({ upsert: ... }, context)` creates or updates variable
  - **Verify:** `npm run test:types`

- [ ] **3.4.4** Create `src/domain.operations/orgVariable/delOrgVariable.ts`
  - **Depends on:** 3.4.1
  - **Acceptance:** Function `delOrgVariable({ variable }, context)` deletes variable
  - **Verify:** `npm run test:types`

### 3.5 Secret Operations

- [ ] **3.5.1** Create `src/domain.operations/orgSecret/getOneOrgSecret.ts`
  - **Depends on:** 2.4.1
  - **Acceptance:** Function `getOneOrgSecret({ by: { unique: { org, name } } }, context)` returns secret metadata or null
  - **Verify:** `npm run test:types`

- [ ] **3.5.2** Create `src/domain.operations/orgSecret/getAllOrgSecrets.ts`
  - **Depends on:** 2.4.1
  - **Acceptance:** Function `getAllOrgSecrets({ org }, context)` returns array of secret metadata
  - **Verify:** `npm run test:types`

- [ ] **3.5.3** Create `src/domain.operations/orgSecret/setOrgSecret.ts`
  - **Depends on:** 3.5.1, 3.3.1, 0.2 (libsodium)
  - **Acceptance:** Function `setOrgSecret({ upsert: ... }, context)`:
    - Encrypts value with org public key
    - Creates or updates secret
    - Throws if no value and secret doesn't exist
    - Throws if visibility changed but no value provided
    - Returns existing if no value and secret exists (no changes needed)
  - **Verify:** `npm run test:types`

- [ ] **3.5.4** Create `src/domain.operations/orgSecret/setOrgSecret.test.ts`
  - **Depends on:** 3.5.3
  - **Acceptance:** Unit test verifies:
    - Error thrown when creating without value
    - Error thrown when changing visibility without value
    - Existing returned when no changes needed
  - **Verify:** `npm run test:unit -- --testPathPattern=setOrgSecret`

- [ ] **3.5.5** Create `src/domain.operations/orgSecret/delOrgSecret.ts`
  - **Depends on:** 3.5.1
  - **Acceptance:** Function `delOrgSecret({ secret }, context)` deletes secret
  - **Verify:** `npm run test:types`

### Phase 3 Checkpoint

- [ ] **3.6** All domain operations compile and tests pass
  - **Verify:** `npm run test:types && npm run test:unit && npm run test:integration`

---

## Phase 4: DAOs

### 4.1 Organization DAO

- [ ] **4.1.1** Create `src/access/daos/DeclaredGithubOrgDao.ts`
  - **Depends on:** 3.1.1, 3.1.3
  - **Acceptance:** DAO with `get.one.byUnique`, `get.one.byRef`, `set.findsert`, `set.upsert`, `set.delete: undefined`
  - **Verify:** `npm run test:types`

### 4.2 Member Privileges DAO

- [ ] **4.2.1** Create `src/access/daos/DeclaredGithubOrgMemberPrivilegesDao.ts`
  - **Depends on:** 3.2.1, 3.2.3
  - **Acceptance:** DAO with `get.one.byUnique`, `get.one.byRef`, `set.findsert`, `set.upsert`, `set.delete: undefined`
  - **Verify:** `npm run test:types`

### 4.3 Variable DAO

- [ ] **4.3.1** Create `src/access/daos/DeclaredGithubOrgVariableDao.ts`
  - **Depends on:** 3.4.1, 3.4.3, 3.4.4
  - **Acceptance:** DAO with `get.one.byUnique`, `get.one.byRef`, `set.findsert`, `set.upsert`, `set.delete`
  - **Verify:** `npm run test:types`

### 4.4 Secret DAO

- [ ] **4.4.1** Create `src/access/daos/DeclaredGithubOrgSecretDao.ts`
  - **Depends on:** 3.5.1, 3.5.3, 3.5.5
  - **Acceptance:** DAO with `get.one.byUnique`, `get.one.byRef`, `set.findsert`, `set.upsert`, `set.delete`
  - **Verify:** `npm run test:types`

### Phase 4 Checkpoint

- [ ] **4.5** All DAOs compile without errors
  - **Verify:** `npm run test:types && npm run test:format && npm run test:lint`

---

## Phase 5: Provider Updates

- [ ] **5.1** Update `src/domain.objects/DeclastructGithubProvider.ts`
  - **Depends on:** 4.1.1, 4.2.1, 4.3.1, 4.4.1
  - **Acceptance:** Type includes:
    - `DeclaredGithubOrg: DeclastructDao<...>`
    - `DeclaredGithubOrgMemberPrivileges: DeclastructDao<...>`
    - `DeclaredGithubOrgVariable: DeclastructDao<...>`
    - `DeclaredGithubOrgSecret: DeclastructDao<...>`
  - **Verify:** `npm run test:types`

- [ ] **5.2** Update `src/domain.operations/provider/getDeclastructGithubProvider.ts`
  - **Depends on:** 5.1
  - **Acceptance:** Provider wires up all 4 new DAOs in `daos` object
  - **Verify:** `npm run test:types`

### Phase 5 Checkpoint

- [ ] **5.3** Provider compiles and existing tests still pass
  - **Verify:** `npm run test:types && npm run test:unit && npm run test:integration`

---

## Phase 6: Exports

- [ ] **6.1** Update `src/contract/sdks/index.ts`
  - **Depends on:** 1.1.1, 1.2.1, 1.3.1, 1.4.1
  - **Acceptance:** Exports:
    - `DeclaredGithubOrg`
    - `DeclaredGithubOrgMemberPrivileges`
    - `DeclaredGithubOrgVariable`
    - `DeclaredGithubOrgSecret`
  - **Verify:** `npm run test:types && npm run build`

### Phase 6 Checkpoint

- [ ] **6.2** Package builds successfully
  - **Verify:** `npm run build && ls dist/contract/sdks/index.js`

---

## Phase 7: Acceptance Tests

- [ ] **7.1** Create `src/contract/sdks/.test/assets/resources.org.acceptance.ts`
  - **Depends on:** 6.1
  - **Acceptance:** File declares:
    - `DeclaredGithubOrg` for ehmpathy
    - `DeclaredGithubOrgMemberPrivileges` with `membersCanDeleteRepositories: false`
  - **Verify:** `npm run test:types`

- [ ] **7.2** Create `src/contract/sdks/declastruct.org.acceptance.test.ts`
  - **Depends on:** 7.1
  - **Acceptance:** Test:
    - Generates plan with `declastruct plan`
    - Plan includes `DeclaredGithubOrgMemberPrivileges` resource
    - Apply is idempotent
  - **Verify:** `npm run test:acceptance:locally -- --testPathPattern=org.acceptance`

### Phase 7 Checkpoint

- [ ] **7.3** All tests pass including acceptance
  - **Verify:** `npm run test`

---

## Phase 8: Final Verification

- [ ] **8.1** Full test suite passes
  - **Verify:** `npm run test`

- [ ] **8.2** Manual verification of wish fulfillment
  - **Acceptance:** Can declare org member privileges in a resources file and:
    1. Run `declastruct plan` - shows member privilege settings
    2. Run `declastruct apply` - successfully applies settings
    3. GitHub UI shows "Repository deletion and transfer" is DISABLED
  - **Verify:** Manual test with real org

- [ ] **8.3** Documentation updated (if applicable)
  - **Acceptance:** README mentions org/member privilege support
  - **Verify:** Manual review

---

## Summary Checklist

| Phase                 | Items | Checkpoint                                         |
| --------------------- | ----- | -------------------------------------------------- |
| 0. Prerequisites      | 2     | libsodium installed, token ready                   |
| 1. Domain Objects     | 5     | `test:types` passes                                |
| 2. Cast Functions     | 5     | `test:types` passes                                |
| 3. Domain Operations  | 16    | `test:types`, `test:unit`, `test:integration` pass |
| 4. DAOs               | 5     | `test:types` passes                                |
| 5. Provider Updates   | 3     | existing tests pass                                |
| 6. Exports            | 2     | `build` succeeds                                   |
| 7. Acceptance Tests   | 3     | `test:acceptance:locally` passes                   |
| 8. Final Verification | 3     | full `test` passes, wish fulfilled                 |

**Total Items:** 44

---

## Quick Commands

```bash
# Phase checkpoints
npm run test:types                                    # Types compile
npm run test:format                                   # Formatting correct
npm run test:lint                                     # Linting passes
npm run test:unit                                     # Unit tests pass
npm run test:integration                              # Integration tests pass
npm run test:acceptance:locally                       # Acceptance tests pass
npm run test                                          # Full test suite
npm run build                                         # Package builds

# Targeted test runs
npm run test:integration -- --testPathPattern=getOneOrg
npm run test:integration -- --testPathPattern=getOneOrgMemberPrivileges
npm run test:unit -- --testPathPattern=setOrgMemberPrivileges
npm run test:unit -- --testPathPattern=setOrgSecret
npm run test:acceptance:locally -- --testPathPattern=org.acceptance
```
