# Blueprint: GitHub Organization Privileges for declastruct-github

## Overview

This blueprint outlines the implementation steps to fulfill the wish of declaratively managing GitHub organization settings, member privileges, variables, and secrets via declastruct.

**Primary Goal:** Enable declarative control of org security settings to guarantee "Repository deletion and transfer" and "Repository visibility change" are disabled for non-owners.

---

## Implementation Phases

### Phase 1: Domain Objects

Create the new domain object files following existing patterns (e.g., `DeclaredGithubRepo.ts`).

| File | Description |
|------|-------------|
| `src/domain.objects/DeclaredGithubOrg.ts` | Org profile (login, name, description, billingEmail) |
| `src/domain.objects/DeclaredGithubOrgMemberPrivileges.ts` | Security settings (membersCanDeleteRepositories, etc.) |
| `src/domain.objects/DeclaredGithubOrgVariable.ts` | Org-level Actions variables |
| `src/domain.objects/DeclaredGithubOrgSecret.ts` | Org-level Actions secrets (write-only) |

**Pattern Reference:** `src/domain.objects/DeclaredGithubRepo.ts`

**Key Implementation Notes:**
- Use `DomainEntity` from `domain-objects`
- Define static `unique`, `readonly`, `writeonly`, `nested` properties
- Use `RefByUnique<typeof DeclaredGithubOrg>` for org references
- Secrets have `writeonly = ['value']` static property

---

### Phase 2: Cast Functions

Create cast functions to transform GitHub API responses to domain objects.

| File | Description |
|------|-------------|
| `src/domain.operations/org/castToDeclaredGithubOrg.ts` | Transform org API response |
| `src/domain.operations/orgMemberPrivileges/castToDeclaredGithubOrgMemberPrivileges.ts` | Transform org API response (extracts member privilege fields) |
| `src/domain.operations/orgVariable/castToDeclaredGithubOrgVariable.ts` | Transform variable API response |
| `src/domain.operations/orgSecret/castToDeclaredGithubOrgSecret.ts` | Transform secret API response (metadata only) |

**Pattern Reference:** `src/domain.operations/repo/castToDeclaredGithubRepo.ts`

**Key Implementation Notes:**
- Use `@octokit/types` `Endpoints` for type-safe API response types
- Use `asUniDateTime` for date conversions
- Cast functions take `{ data, org }` object (no ordered args)

---

### Phase 3: Domain Operations

Create get/set operations following the existing patterns.

#### Organization Operations

| File | Description |
|------|-------------|
| `src/domain.operations/org/getOneOrg.ts` | GET /orgs/{org} |
| `src/domain.operations/org/setOrg.ts` | PATCH /orgs/{org} (cannot create via API) |

#### Member Privileges Operations

| File | Description |
|------|-------------|
| `src/domain.operations/orgMemberPrivileges/getOneOrgMemberPrivileges.ts` | GET /orgs/{org} (extract member privilege fields) |
| `src/domain.operations/orgMemberPrivileges/setOrgMemberPrivileges.ts` | PATCH /orgs/{org} (member privilege fields only) |

#### Variable Operations

| File | Description |
|------|-------------|
| `src/domain.operations/orgVariable/getOneOrgVariable.ts` | GET /orgs/{org}/actions/variables/{name} |
| `src/domain.operations/orgVariable/getAllOrgVariables.ts` | GET /orgs/{org}/actions/variables |
| `src/domain.operations/orgVariable/setOrgVariable.ts` | POST/PATCH /orgs/{org}/actions/variables/{name} |
| `src/domain.operations/orgVariable/delOrgVariable.ts` | DELETE /orgs/{org}/actions/variables/{name} |

#### Secret Operations

| File | Description |
|------|-------------|
| `src/domain.operations/orgSecret/getOneOrgSecret.ts` | GET /orgs/{org}/actions/secrets/{name} (metadata only) |
| `src/domain.operations/orgSecret/getAllOrgSecrets.ts` | GET /orgs/{org}/actions/secrets |
| `src/domain.operations/orgSecret/setOrgSecret.ts` | PUT /orgs/{org}/actions/secrets/{name} (with encryption) |
| `src/domain.operations/orgSecret/delOrgSecret.ts` | DELETE /orgs/{org}/actions/secrets/{name} |

#### Helper Operations

| File | Description |
|------|-------------|
| `src/domain.operations/repo/getRepoIdsByNames.ts` | Resolve repo names to IDs for selected visibility |

**Pattern Reference:** `src/domain.operations/repo/getRepo.ts`, `src/domain.operations/repo/setRepo.ts`

**Key Implementation Notes:**
- Use `asProcedure` wrapper
- Use `{ by: { unique: ... } }` pattern for getters
- Use `PickOne<{ finsert: ...; upsert: ... }>` for setters
- Extract `.login` from `RefByUnique<typeof DeclaredGithubOrg>` for API calls

---

### Phase 4: DAOs

Create declastruct DAOs that wrap domain operations.

| File | Description |
|------|-------------|
| `src/access/daos/DeclaredGithubOrgDao.ts` | DAO for org profile |
| `src/access/daos/DeclaredGithubOrgMemberPrivilegesDao.ts` | DAO for member privileges |
| `src/access/daos/DeclaredGithubOrgVariableDao.ts` | DAO for variables |
| `src/access/daos/DeclaredGithubOrgSecretDao.ts` | DAO for secrets |

**Pattern Reference:** `src/access/daos/DeclaredGithubRepoDao.ts`

**Key Implementation Notes:**
- Use `DeclastructDao` from `declastruct`
- Wire up `get.one.byUnique`, `get.one.byRef`
- Wire up `set.finsert`, `set.upsert`, `set.delete` (where applicable)
- Org and MemberPrivileges have `delete: undefined` (cannot delete)

---

### Phase 5: Provider Updates

Update the provider to include new DAOs.

| File | Changes |
|------|---------|
| `src/domain.objects/DeclastructGithubProvider.ts` | Add types for new DAOs |
| `src/domain.operations/provider/getDeclastructGithubProvider.ts` | Wire up new DAOs |

**Pattern Reference:** Current `getDeclastructGithubProvider.ts`

---

### Phase 6: Exports

Update public SDK exports.

| File | Changes |
|------|---------|
| `src/contract/sdks/index.ts` | Export new domain objects |

---

### Phase 7: Dependencies

Add required dependency for secret encryption.

```bash
pnpm add libsodium-wrappers
pnpm add -D @types/libsodium-wrappers
```

---

### Phase 8: Tests

#### Integration Tests

| File | Description |
|------|-------------|
| `src/domain.operations/org/getOneOrg.integration.test.ts` | Test getting org |
| `src/domain.operations/orgMemberPrivileges/getOneOrgMemberPrivileges.integration.test.ts` | Test getting member privileges |
| `src/domain.operations/orgVariable/getOneOrgVariable.integration.test.ts` | Test getting variable |
| `src/domain.operations/orgSecret/getOneOrgSecret.integration.test.ts` | Test getting secret metadata |

#### Unit Tests

| File | Description |
|------|-------------|
| `src/domain.operations/orgMemberPrivileges/setOrgMemberPrivileges.test.ts` | Test upsert logic |
| `src/domain.operations/orgSecret/setOrgSecret.test.ts` | Test write-only behavior |

#### Acceptance Tests

| File | Description |
|------|-------------|
| `src/contract/sdks/.test/assets/resources.org.acceptance.ts` | Declare org resources for testing |
| `src/contract/sdks/declastruct.org.acceptance.test.ts` | End-to-end org management test |

**Pattern Reference:** `src/domain.operations/repo/getRepo.integration.test.ts`, `src/contract/sdks/declastruct.acceptance.test.ts`

---

## Implementation Order

```
1. Domain Objects (Phase 1)
   └── Foundation types needed by everything else

2. Cast Functions (Phase 2)
   └── Required by domain operations

3. Domain Operations (Phase 3)
   └── Core business logic
   └── Order within phase:
       a. getOne* operations first
       b. getAll* operations
       c. set* operations (depend on getOne*)
       d. del* operations

4. DAOs (Phase 4)
   └── Depends on domain operations

5. Provider Updates (Phase 5)
   └── Depends on DAOs

6. Exports (Phase 6)
   └── Final wiring

7. Dependencies (Phase 7)
   └── Can be done anytime before setOrgSecret

8. Tests (Phase 8)
   └── Throughout, but integration tests after Phase 3
```

---

## File Tree (New Files)

```
src/
├── domain.objects/
│   ├── DeclaredGithubOrg.ts                          # NEW
│   ├── DeclaredGithubOrgMemberPrivileges.ts          # NEW
│   ├── DeclaredGithubOrgVariable.ts                  # NEW
│   └── DeclaredGithubOrgSecret.ts                    # NEW
│
├── domain.operations/
│   ├── org/
│   │   ├── castToDeclaredGithubOrg.ts                # NEW
│   │   ├── getOneOrg.ts                              # NEW
│   │   ├── getOneOrg.integration.test.ts             # NEW
│   │   └── setOrg.ts                                 # NEW
│   │
│   ├── orgMemberPrivileges/
│   │   ├── castToDeclaredGithubOrgMemberPrivileges.ts # NEW
│   │   ├── getOneOrgMemberPrivileges.ts              # NEW
│   │   ├── getOneOrgMemberPrivileges.integration.test.ts # NEW
│   │   ├── setOrgMemberPrivileges.ts                 # NEW
│   │   └── setOrgMemberPrivileges.test.ts            # NEW
│   │
│   ├── orgVariable/
│   │   ├── castToDeclaredGithubOrgVariable.ts        # NEW
│   │   ├── getOneOrgVariable.ts                      # NEW
│   │   ├── getOneOrgVariable.integration.test.ts     # NEW
│   │   ├── getAllOrgVariables.ts                     # NEW
│   │   ├── setOrgVariable.ts                         # NEW
│   │   └── delOrgVariable.ts                         # NEW
│   │
│   ├── orgSecret/
│   │   ├── castToDeclaredGithubOrgSecret.ts          # NEW
│   │   ├── getOneOrgSecret.ts                        # NEW
│   │   ├── getOneOrgSecret.integration.test.ts       # NEW
│   │   ├── getAllOrgSecrets.ts                       # NEW
│   │   ├── setOrgSecret.ts                           # NEW
│   │   ├── setOrgSecret.test.ts                      # NEW
│   │   └── delOrgSecret.ts                           # NEW
│   │
│   └── repo/
│       └── getRepoIdsByNames.ts                      # NEW
│
├── access/daos/
│   ├── DeclaredGithubOrgDao.ts                       # NEW
│   ├── DeclaredGithubOrgMemberPrivilegesDao.ts       # NEW
│   ├── DeclaredGithubOrgVariableDao.ts               # NEW
│   └── DeclaredGithubOrgSecretDao.ts                 # NEW
│
└── contract/sdks/
    ├── index.ts                                      # UPDATE
    └── .test/assets/
        └── resources.org.acceptance.ts               # NEW
```

---

## Modified Files

| File | Changes |
|------|---------|
| `src/domain.objects/DeclastructGithubProvider.ts` | Add 4 new DAO types |
| `src/domain.operations/provider/getDeclastructGithubProvider.ts` | Import and wire 4 new DAOs |
| `src/contract/sdks/index.ts` | Export 4 new domain objects |
| `package.json` | Add libsodium-wrappers dependency |

---

## Verification Checklist

After implementation, verify:

- [ ] `npm run test:types` passes
- [ ] `npm run test:format` passes
- [ ] `npm run test:lint` passes
- [ ] `npm run test:unit` passes
- [ ] `npm run test:integration` passes (requires GITHUB_TOKEN with admin:org scope)
- [ ] `npm run test:acceptance:locally` passes
- [ ] Can declare org member privileges in resources file
- [ ] Running `declastruct plan` shows member privilege changes
- [ ] Running `declastruct apply` correctly sets `membersCanDeleteRepositories: false`

---

## Example Usage (Post-Implementation)

```typescript
import {
  DeclaredGithubOrg,
  DeclaredGithubOrgMemberPrivileges,
  DeclaredGithubOrgVariable,
  DeclaredGithubOrgSecret,
  getDeclastructGithubProvider,
} from 'declastruct-github';

export const getProviders = async () => [
  getDeclastructGithubProvider(
    { credentials: { token: process.env.GITHUB_TOKEN! } },
    { log },
  ),
];

export const getResources = async () => {
  const org = DeclaredGithubOrg.as({
    login: 'ehmpathy',
    name: 'Ehmpathy',
    description: 'Building empathetic software',
    billingEmail: 'billing@ehmpathy.com',
  });

  // KEY SECURITY SETTINGS - wish fulfillment
  const memberPrivileges = DeclaredGithubOrgMemberPrivileges.as({
    org: { login: 'ehmpathy' },
    membersCanDeleteRepositories: false,      // DISABLED - only owners
    membersCanChangeRepoVisibility: false,    // DISABLED - only owners
    membersCanCreateRepositories: true,
    membersCanCreatePublicRepositories: true,
    membersCanCreatePrivateRepositories: true,
    membersCanCreateInternalRepositories: null,
    membersCanForkPrivateRepositories: false,
    membersCanInviteOutsideCollaborators: true,
    membersCanCreateTeams: true,
    membersCanCreatePages: true,
    membersCanCreatePublicPages: true,
    membersCanCreatePrivatePages: true,
    membersCanViewDependencyInsights: true,
    defaultRepositoryPermission: 'read',
  });

  const npmToken = DeclaredGithubOrgVariable.as({
    org: { login: 'ehmpathy' },
    name: 'NPM_TOKEN_READ_ONLY',
    value: process.env.NPM_TOKEN_READ_ONLY!,
    visibility: 'all',
  });

  const deployKey = DeclaredGithubOrgSecret.as({
    org: { login: 'ehmpathy' },
    name: 'DEPLOY_KEY',
    value: process.env.DEPLOY_KEY, // write-only; undefined = keep existing
    visibility: 'private',
  });

  return [org, memberPrivileges, npmToken, deployKey];
};
```

---

## Risk Considerations

1. **Token Permissions:** Requires `admin:org` scope - document this clearly
2. **Org Must Exist:** Cannot create orgs via API - throw helpful error
3. **Secret Encryption:** Depends on libsodium - add to dependencies
4. **Visibility Changes for Secrets:** Cannot update visibility without re-providing value - throw helpful error
5. **Enterprise-Only Fields:** `membersCanCreateInternalRepositories` is enterprise-only - handle as nullable
