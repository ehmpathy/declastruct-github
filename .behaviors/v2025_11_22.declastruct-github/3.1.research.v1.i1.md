# Research: GitHub APIs and SDKs for declastruct-github

## Overview

This document outlines the available GitHub REST APIs and SDKs to support the implementation of `declastruct-github` - a declarative infrastructure-as-code tool for managing GitHub resources (repositories, branches, repository configuration, and branch protection).

## Wish Requirements

Based on `.behaviors/v2025_11_22.declastruct-github/0.wish.md` and `readme.md`, the project aims to:

1. **Replace Terraform for GitHub management** with a simpler, stateless declarative approach
2. **Manage GitHub resources declaratively** including:
   - `DeclaredGithubRepo` - repositories
   - `DeclaredGithubBranch` - branches
   - `DeclaredGithubRepoConfig` - repository settings
   - `DeclaredGithubBranchProtection` - branch protection rules

3. **Support imperative operations** for each resource type:
   - `get{Resource}` - fetch single resource
   - `get{Resource}s` - list resources
   - `set{Resource}` - create or update resource

## GitHub REST API Documentation

### Official SDK: Octokit

**Primary Package:** `@octokit/rest`
- **npm:** https://www.npmjs.com/package/@octokit/rest
- **GitHub:** https://github.com/octokit/rest.js
- **Installation:** `npm install @octokit/rest`

**TypeScript Support:**
- Full TypeScript definitions included
- **Types Package:** `@octokit/types` provides shared TypeScript definitions
- For conditional exports, configure `tsconfig.json`:
  ```json
  {
    "compilerOptions": {
      "moduleResolution": "node16",
      "module": "node16"
    }
  }
  ```

**Alternative Packages:**
- `octokit` - All-in-one package (REST, GraphQL, and Apps)
- `@octokit/core` - Core library for building plugins
- `@octokit/graphql` - GraphQL API client

## API Endpoints by Resource Type

### 1. DeclaredGithubRepo

**List Repositories**
- `GET /orgs/{org}/repos`
- Lists all repositories in an organization
- Supports filtering and sorting

**Get Repository**
- `GET /repos/{owner}/{repo}`
- Retrieves detailed information about a specific repository
- Returns configuration, security settings, and metadata

**Create Repository**
- `POST /orgs/{org}/repos`
- Creates a new repository in an organization
- Requires "Administration" permissions (write)

**Update Repository**
- `PATCH /repos/{owner}/{repo}`
- Updates repository settings
- Requires "Administration" permissions (write)

**Delete Repository**
- `DELETE /repos/{owner}/{repo}`
- Permanently deletes a repository
- Requires owner/admin permissions

### 2. DeclaredGithubBranch

**List Branches**
- `GET /repos/{owner}/{repo}/branches`
- Retrieves all branches in a repository
- Parameters:
  - `protected` (boolean): Filter by protection status
  - `per_page` (integer): Results per page (max 100, default 30)
  - `page` (integer): Page number
- Response: 200 (OK), 404 (Not Found)

**Get Branch**
- `GET /repos/{owner}/{repo}/branches/{branch}`
- Retrieves detailed information about a specific branch
- **Note:** Cannot contain wildcard characters (use GraphQL API for wildcards)
- Response: 200 (OK), 301 (Moved), 404 (Not Found)

**Rename Branch**
- `POST /repos/{owner}/{repo}/branches/{branch}/rename`
- Renames an existing branch
- Body parameter: `new_name` (string)
- Requires push access; admin/owner for default branch
- Response: 201 (Created), 403 (Forbidden), 404 (Not Found), 422 (Validation Failed)

**Merge Branch**
- `POST /repos/{owner}/{repo}/merges`
- Merges one branch into another
- Parameters: `base` (target), `head` (source), `commit_message` (optional)
- Response: 201 (Success), 204 (Already Merged), 409 (Conflict), 422 (Validation)

**Sync Fork Branch**
- `POST /repos/{owner}/{repo}/merge-upstream`
- Synchronizes a forked branch with upstream
- Body parameter: `branch` (string)
- Response: 200 (Success), 409 (Conflict), 422 (Error)

### 3. DeclaredGithubRepoConfig

The repository configuration is managed through the **Update Repository** endpoint:

**Update Repository Configuration**
- `PATCH /repos/{owner}/{repo}`
- Requires "Administration" permissions (write)

**Available Configuration Options:**

**Basic Properties:**
- `name` - Repository name
- `description` - Repository description
- `homepage` - Homepage URL
- `private` - Visibility (public/private)
- `default_branch` - Default branch name

**Feature Toggles:**
- `has_issues` - Enable/disable issues
- `has_projects` - Enable/disable projects
- `has_wiki` - Enable/disable wiki
- `has_downloads` - Enable/disable downloads
- `has_discussions` - Enable/disable discussions
- `is_template` - Mark as template repository

**Merge Settings:**
- `allow_squash_merge` - Allow squash merging
- `allow_merge_commit` - Allow merge commits
- `allow_rebase_merge` - Allow rebase merging
- `allow_auto_merge` - Enable auto-merge
- `delete_branch_on_merge` - Automatically delete head branches after merge
- `squash_merge_commit_title` - Default squash merge commit title
- `squash_merge_commit_message` - Default squash merge commit message
- `merge_commit_title` - Default merge commit title
- `merge_commit_message` - Default merge commit message

**Security & Analysis:**
- GitHub Advanced Security status
- Secret scanning and push protection
- Code security settings

**Additional Controls:**
- `web_commit_signoff_required` - Require commit signatures via web
- `archived` - Archive/unarchive repository
- Forking permissions and branch update permissions

### 4. DeclaredGithubBranchProtection

**Get Branch Protection**
- `GET /repos/{owner}/{repo}/branches/{branch}/protection`
- Returns current protection settings
- Response: 200 (OK), 404 (Not Found)

**Update Branch Protection**
- `PUT /repos/{owner}/{repo}/branches/{branch}/protection`
- Sets or updates all protection rules
- Response: 200 (OK), 403 (Forbidden), 404 (Not Found), 422 (Validation Failed)

**Delete Branch Protection**
- `DELETE /repos/{owner}/{repo}/branches/{branch}/protection`
- Removes all protection rules
- Response: 204 (No Content), 403 (Forbidden)

**Protection Configuration Parameters:**

**Required Status Checks:**
- `required_status_checks` - Status checks configuration
  - `strict` (boolean): Branch must be up to date before merging
  - `contexts` (array): List of required status check contexts
- Specific endpoint: `PATCH /repos/{owner}/{repo}/branches/{branch}/protection/required_status_checks`
- Context management:
  - `GET` - List contexts
  - `POST` - Add contexts
  - `PUT` - Set/replace contexts
  - `DELETE` - Remove contexts
- Path: `/repos/{owner}/{repo}/branches/{branch}/protection/required_status_checks/contexts`

**Pull Request Reviews:**
- `required_pull_request_reviews` - PR review requirements
  - Dismissal restrictions
  - Stale review dismissal
  - Code owner reviews requirement
  - Required approving review count
- Endpoint: `PATCH /repos/{owner}/{repo}/branches/{branch}/protection/required_pull_request_reviews`

**Admin Enforcement:**
- `enforce_admins` (boolean): Apply rules to administrators
- Specific endpoints:
  - `GET /repos/{owner}/{repo}/branches/{branch}/protection/enforce_admins`
  - `POST /repos/{owner}/{repo}/branches/{branch}/protection/enforce_admins` - Enable
  - `DELETE /repos/{owner}/{repo}/branches/{branch}/protection/enforce_admins` - Disable

**Commit Requirements:**
- `required_signatures` - Require signed commits
- Endpoints:
  - `GET /repos/{owner}/{repo}/branches/{branch}/protection/required_signatures`
  - `POST` - Enable
  - `DELETE` - Disable

**Branch Restrictions:**
- `restrictions` - User/team/app access restrictions
- `allow_deletions` (boolean): Allow branch deletion
- `allow_force_pushes` (boolean): Allow force pushes
- `required_linear_history` (boolean): Require linear history (no merge commits)
- `block_creations` (boolean): Block branch creation
- `lock_branch` (boolean): Lock branch (read-only)
- `allow_fork_syncing` (boolean): Allow fork syncing
- `required_conversation_resolution` (boolean): Require conversation resolution before merging

**Access Restriction Management:**
- User restrictions: `/repos/{owner}/{repo}/branches/{branch}/protection/restrictions/users`
- Team restrictions: `/repos/{owner}/{repo}/branches/{branch}/protection/restrictions/teams`
- App restrictions: `/repos/{owner}/{repo}/branches/{branch}/protection/restrictions/apps`
- Each supports: GET, POST, PUT, DELETE operations

## Authentication

**Required for API Access:**
- Personal Access Tokens (classic or fine-grained)
- GitHub App installation tokens
- GitHub App user tokens

**Fine-Grained Personal Access Tokens (Recommended):**
- More granular permission control
- Repository-specific access
- Required expiration dates
- Separate read/write permissions

**Required Permissions by Resource:**

| Resource | Operation | Permission Required |
|----------|-----------|---------------------|
| Repository | Read | "Metadata" (read) |
| Repository | Create/Update/Delete | "Administration" (write) |
| Branch | List/Get | "Contents" (read) |
| Branch | Create/Rename/Merge | "Contents" (write) |
| Branch Protection | Read | "Administration" (read) |
| Branch Protection | Update/Delete | "Administration" (write) |

**Authentication Example:**
```typescript
import { Octokit } from '@octokit/rest';

const octokit = new Octokit({
  auth: process.env.GITHUB_TOKEN
});
```

## Implementation Recommendations

### 1. Use @octokit/rest for API interactions
- Official GitHub SDK with full TypeScript support
- Well-maintained and documented
- Built-in pagination, retry logic, and request throttling
- Type-safe API methods

### 2. API Mapping to Resources

**DeclaredGithubRepo:**
- `getRepos()` → `GET /orgs/{org}/repos` or `GET /user/repos`
- `getRepo()` → `GET /repos/{owner}/{repo}`
- `setRepo()` → Create: `POST /orgs/{org}/repos`, Update: `PATCH /repos/{owner}/{repo}`

**DeclaredGithubBranch:**
- `getBranches()` → `GET /repos/{owner}/{repo}/branches`
- `getBranch()` → `GET /repos/{owner}/{repo}/branches/{branch}`
- `setBranch()` → Use Git API to create refs: `POST /repos/{owner}/{repo}/git/refs`

**DeclaredGithubRepoConfig:**
- `getRepoConfig()` → `GET /repos/{owner}/{repo}` (extract config fields)
- `setRepoConfig()` → `PATCH /repos/{owner}/{repo}` (update config fields)

**DeclaredGithubBranchProtection:**
- `getBranchProtection()` → `GET /repos/{owner}/{repo}/branches/{branch}/protection`
- `setBranchProtection()` → `PUT /repos/{owner}/{repo}/branches/{branch}/protection`

### 3. Error Handling

Common HTTP status codes to handle:
- **200/201** - Success
- **204** - Success (no content)
- **403** - Forbidden (insufficient permissions)
- **404** - Not Found (resource doesn't exist)
- **422** - Validation Failed (invalid parameters)

### 4. Considerations

**Branch Creation:**
- GitHub REST API doesn't have a direct "create branch" endpoint
- Use the Git Data API to create a reference (ref):
  - `POST /repos/{owner}/{repo}/git/refs`
  - Body: `{ "ref": "refs/heads/branch-name", "sha": "commit-sha" }`
- Requires the SHA of an existing commit to point the new branch to

**Branch Protection Limitations:**
- Some advanced protection features may require GitHub Enterprise
- Wildcard branch names require GraphQL API
- Status check contexts must match exactly as reported by CI/CD systems

**Repository Settings:**
- Some settings may be organization-level restricted
- Changing default branch requires the target branch to exist
- Archived repositories cannot be modified (must unarchive first)

## Sources

- [REST API endpoints for protected branches - GitHub Docs](https://docs.github.com/en/rest/branches/branch-protection)
- [Managing a branch protection rule - GitHub Docs](https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-protected-branches/managing-a-branch-protection-rule)
- [About protected branches - GitHub Docs](https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-protected-branches/about-protected-branches)
- [About status checks - GitHub Docs](https://docs.github.com/articles/about-status-checks)
- [@octokit/rest - npm](https://www.npmjs.com/package/@octokit/rest)
- [@octokit/types - npm](https://www.npmjs.com/package/@octokit/types)
- [GitHub - octokit/types.ts: Shared TypeScript definitions for Octokit projects](https://github.com/octokit/types.ts)
- [GitHub - octokit/rest.js: GitHub REST API client for JavaScript](https://github.com/octokit/rest.js)

## Next Steps

1. Install `@octokit/rest` and `@octokit/types` packages
2. Create domain objects for each resource type with proper TypeScript typing
3. Implement `get*` operations using the REST API endpoints
4. Implement `set*` operations with proper diff detection (compare current vs desired state)
5. Handle authentication via environment variables (`GITHUB_TOKEN`)
6. Implement error handling for common API error scenarios
7. Add pagination support for list operations
8. Consider rate limiting and retry logic (Octokit handles this by default)
