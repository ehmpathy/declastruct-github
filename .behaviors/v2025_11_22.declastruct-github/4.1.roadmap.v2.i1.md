# Roadmap v2: declastruct-github Implementation

## Overview

This roadmap details the step-by-step execution of Blueprint v2, implementing declarative GitHub resource management following the established AWS Lambda patterns in the codebase.

---

## Phase 1: Core Infrastructure Setup

**Goal:** Establish GitHub SDK integration and test infrastructure

### 1.1 Install GitHub SDK Dependency

**Task:** Add @octokit/rest to package.json dependencies

**Acceptance Criteria:**
- Package.json includes `"@octokit/rest": "^21.0.0"` in dependencies
- npm install completes successfully
- node_modules contains @octokit/rest package

**Verification:**
```bash
# Run installation
npm install

# Verify package exists
ls node_modules/@octokit/rest

# Check no dependency conflicts
npm ls @octokit/rest
```

**Dependencies:** None

---

### 1.2 Create ContextGithubApi Domain Object

**Task:** Implement src/domain.objects/ContextGithubApi.ts

**Acceptance Criteria:**
- File exists at src/domain.objects/ContextGithubApi.ts
- Exports ContextGithubApi interface with structure:
  ```typescript
  export interface ContextGithubApi {
    github: {
      token: string;
      owner?: string;
    };
  }
  ```
- TypeScript compilation succeeds
- Follows same pattern as ContextAwsApi.ts

**Verification:**
```bash
# Verify file exists
ls src/domain.objects/ContextGithubApi.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify exports
grep "export interface ContextGithubApi" src/domain.objects/ContextGithubApi.ts
```

**Dependencies:** None

---

### 1.3 Create GitHub Context Test Helper

**Task:** Implement src/__test_assets__/getSampleGithubContext.ts

**Acceptance Criteria:**
- File exists at src/__test_assets__/getSampleGithubContext.ts
- Exports getSampleGithubContext function
- Reads GITHUB_TOKEN and GITHUB_TEST_OWNER from environment
- Returns ContextGithubApi type
- Follows pattern from getSampleAwsApiContext.ts

**Verification:**
```bash
# Verify file exists
ls src/__test_assets__/getSampleGithubContext.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify it reads env vars
grep "process.env.GITHUB_TOKEN" src/__test_assets__/getSampleGithubContext.ts
grep "process.env.GITHUB_TEST_OWNER" src/__test_assets__/getSampleGithubContext.ts
```

**Dependencies:** 1.2 (requires ContextGithubApi)

---

### 1.4 Create Sample Repo Test Helper

**Task:** Implement src/__test_assets__/getSampleRepo.ts

**Acceptance Criteria:**
- File exists at src/__test_assets__/getSampleRepo.ts
- Exports getSampleRepo function
- Reads GITHUB_TEST_OWNER and GITHUB_TEST_REPO from environment
- Returns object with owner and name properties
- Follows pattern from getSampleLambda.ts

**Verification:**
```bash
# Verify file exists
ls src/__test_assets__/getSampleRepo.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify env var usage
grep "GITHUB_TEST_OWNER" src/__test_assets__/getSampleRepo.ts
grep "GITHUB_TEST_REPO" src/__test_assets__/getSampleRepo.ts
```

**Dependencies:** None

---

### 1.5 Phase 1 Validation

**Task:** Verify all Phase 1 deliverables are complete

**Acceptance Criteria:**
- All Phase 1 files exist
- TypeScript compilation succeeds
- No npm install errors
- Test helpers can be imported without errors

**Verification:**
```bash
# Verify all files exist
ls src/domain.objects/ContextGithubApi.ts
ls src/__test_assets__/getSampleGithubContext.ts
ls src/__test_assets__/getSampleRepo.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify npm dependencies
npm ls @octokit/rest
```

**Dependencies:** 1.1, 1.2, 1.3, 1.4

---

## Phase 2: Repository Resource Implementation

**Goal:** Implement complete DeclaredGithubRepo resource with all operations

### 2.1 Create DeclaredGithubRepo Domain Object

**Task:** Implement src/domain.objects/DeclaredGithubRepo.ts

**Acceptance Criteria:**
- File exists at src/domain.objects/DeclaredGithubRepo.ts
- Exports DeclaredGithubRepo interface with all fields from blueprint
- Exports DeclaredGithubRepo class extending DomainEntity
- Class defines `public static primary = ['id'] as const`
- Class defines `public static unique = ['owner', 'name'] as const`
- Follows exact pattern from DeclaredAwsLambda.ts

**Verification:**
```bash
# Verify file exists
ls src/domain.objects/DeclaredGithubRepo.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify class structure
grep "public static primary = \['id'\]" src/domain.objects/DeclaredGithubRepo.ts
grep "public static unique = \['owner', 'name'\]" src/domain.objects/DeclaredGithubRepo.ts
```

**Dependencies:** Phase 1 complete (1.5)

---

### 2.2 Create castToDeclaredGithubRepo Function

**Task:** Implement src/domain.operations/repo/castToDeclaredGithubRepo.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/repo/castToDeclaredGithubRepo.ts
- Exports castToDeclaredGithubRepo function
- Accepts Octokit repository response type
- Returns HasMetadata<DeclaredGithubRepo>
- Uses getOrThrow for required fields
- Handles optional fields with ?? null pattern
- Follows pattern from castToDeclaredAwsLambda.ts

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/repo/castToDeclaredGithubRepo.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify uses getOrThrow
grep "getOrThrow" src/domain.operations/repo/castToDeclaredGithubRepo.ts

# Verify function export
grep "export const castToDeclaredGithubRepo" src/domain.operations/repo/castToDeclaredGithubRepo.ts
```

**Dependencies:** 2.1 (requires DeclaredGithubRepo)

---

### 2.3 Implement getRepo Operation

**Task:** Implement src/domain.operations/repo/getRepo.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/repo/getRepo.ts
- Exports getRepo function wrapped with asProcedure
- Accepts `by: { primary | unique | ref }` parameter
- Accepts VisualogicContext parameter
- Returns `HasMetadata<DeclaredGithubRepo> | null`
- Handles ref delegation to primary/unique
- Initializes Octokit client within function
- Uses github.repos.get API
- Returns null for 404/Not Found errors
- Throws HelpfulError for other errors
- Follows exact pattern from getLambda.ts

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/repo/getRepo.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify uses asProcedure
grep "asProcedure" src/domain.operations/repo/getRepo.ts

# Verify error handling
grep "HelpfulError" src/domain.operations/repo/getRepo.ts
grep "return null" src/domain.operations/repo/getRepo.ts
```

**Dependencies:** 2.2 (requires castToDeclaredGithubRepo)

---

### 2.4 Create getRepo Integration Test

**Task:** Implement src/domain.operations/repo/getRepo.integration.test.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/repo/getRepo.integration.test.ts
- Uses given/then test structure from test-fns
- Tests getting repo by unique key (owner + name)
- Tests getting repo that doesn't exist (returns null)
- Uses getSampleGithubContext and getSampleRepo
- Includes console logging for debugging
- Follows pattern from getLambda.integration.test.ts

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/repo/getRepo.integration.test.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Run integration test with real credentials
GITHUB_TOKEN=<token> GITHUB_TEST_OWNER=ehmpathy GITHUB_TEST_REPO=declastruct-github npm run test:integration -- getRepo.integration.test

# Verify test passes
echo $? # Should be 0
```

**Dependencies:** 2.3 (requires getRepo)

---

### 2.5 Implement getRepos Operation

**Task:** Implement src/domain.operations/repo/getRepos.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/repo/getRepos.ts
- Exports getRepos function wrapped with asProcedure
- Accepts optional `where: { owner?: string }` parameter
- Accepts optional `page: { range?, limit? }` parameter
- Accepts VisualogicContext parameter
- Returns `HasMetadata<DeclaredGithubRepo>[]`
- Uses github.repos.listForAuthenticatedUser or github.repos.listForOrg
- Handles pagination correctly
- Follows pattern from getLambdas.ts

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/repo/getRepos.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify uses asProcedure
grep "asProcedure" src/domain.operations/repo/getRepos.ts
```

**Dependencies:** 2.2 (requires castToDeclaredGithubRepo)

---

### 2.6 Create getRepos Integration Test

**Task:** Implement src/domain.operations/repo/getRepos.integration.test.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/repo/getRepos.integration.test.ts
- Uses given/then test structure
- Tests listing repos for authenticated user
- Tests listing repos for specific owner if applicable
- Verifies returns array of repos
- Uses getSampleGithubContext
- Follows pattern from getLambdas.integration.test.ts

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/repo/getRepos.integration.test.ts

# Run integration test
GITHUB_TOKEN=<token> npm run test:integration -- getRepos.integration.test

# Verify test passes
echo $?
```

**Dependencies:** 2.5 (requires getRepos)

---

### 2.7 Implement setRepo Operation

**Task:** Implement src/domain.operations/repo/setRepo.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/repo/setRepo.ts
- Exports setRepo function wrapped with asProcedure
- Accepts `PickOne<{ finsert, upsert }>` parameter with DeclaredGithubRepo
- Accepts VisualogicContext parameter
- Returns `HasMetadata<DeclaredGithubRepo>`
- Checks existence via getRepo using unique key
- For finsert: returns existing if found
- For upsert/finsert: creates if not found using github.repos.createForAuthenticatedUser or createInOrg
- For upsert: updates if found using github.repos.update
- Follows exact pattern from setLambda.ts

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/repo/setRepo.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify uses getRepo
grep "getRepo" src/domain.operations/repo/setRepo.ts

# Verify handles finsert/upsert
grep "finsert" src/domain.operations/repo/setRepo.ts
grep "upsert" src/domain.operations/repo/setRepo.ts
```

**Dependencies:** 2.3 (requires getRepo), 2.2 (requires castToDeclaredGithubRepo)

---

### 2.8 Create setRepo Unit Test

**Task:** Implement src/domain.operations/repo/setRepo.test.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/repo/setRepo.test.ts
- Uses jest mocking patterns
- Tests finsert behavior (returns existing)
- Tests upsert behavior (creates or updates)
- Mocks getRepo responses
- Mocks Octokit API calls
- Follows pattern from setLambda.test.ts

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/repo/setRepo.test.ts

# Run unit test
npm test -- setRepo.test

# Verify test passes
echo $?
```

**Dependencies:** 2.7 (requires setRepo)

---

### 2.9 Create setRepo Integration Test

**Task:** Implement src/domain.operations/repo/setRepo.integration.test.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/repo/setRepo.integration.test.ts
- Uses given/then test structure
- Tests creating new repo (or finsert if exists)
- Tests updating existing repo
- Uses real GitHub API
- Cleans up test resources if needed
- Uses getSampleGithubContext
- Follows pattern from setLambda.integration.test.ts

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/repo/setRepo.integration.test.ts

# Run integration test
GITHUB_TOKEN=<token> GITHUB_TEST_OWNER=ehmpathy npm run test:integration -- setRepo.integration.test

# Verify test passes
echo $?
```

**Dependencies:** 2.7 (requires setRepo)

---

### 2.10 Phase 2 Validation

**Task:** Verify all Phase 2 deliverables are complete

**Acceptance Criteria:**
- All repo resource files exist
- TypeScript compilation succeeds
- All unit tests pass
- All integration tests pass with real GitHub API
- getRepo, getRepos, setRepo operations work correctly

**Verification:**
```bash
# Verify all files exist
ls src/domain.objects/DeclaredGithubRepo.ts
ls src/domain.operations/repo/castToDeclaredGithubRepo.ts
ls src/domain.operations/repo/getRepo.ts
ls src/domain.operations/repo/getRepo.integration.test.ts
ls src/domain.operations/repo/getRepos.ts
ls src/domain.operations/repo/getRepos.integration.test.ts
ls src/domain.operations/repo/setRepo.ts
ls src/domain.operations/repo/setRepo.test.ts
ls src/domain.operations/repo/setRepo.integration.test.ts

# Run all tests
npm test -- repo/
npm run test:integration -- repo/

# Verify TypeScript compiles
npx tsc --noEmit
```

**Dependencies:** 2.1-2.9

---

## Phase 3: Branch Resource Implementation

**Goal:** Implement complete DeclaredGithubBranch resource with all operations

### 3.1 Create DeclaredGithubBranch Domain Object

**Task:** Implement src/domain.objects/DeclaredGithubBranch.ts

**Acceptance Criteria:**
- File exists at src/domain.objects/DeclaredGithubBranch.ts
- Exports DeclaredGithubBranch interface with all fields from blueprint
- Uses `Ref<typeof DeclaredGithubRepo>` for repo field
- Exports DeclaredGithubBranch class extending DomainEntity
- Class defines `public static primary = ['sha'] as const`
- Class defines `public static unique = ['repo', 'name'] as const`

**Verification:**
```bash
# Verify file exists
ls src/domain.objects/DeclaredGithubBranch.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify uses Ref type
grep "Ref<typeof DeclaredGithubRepo>" src/domain.objects/DeclaredGithubBranch.ts

# Verify class structure
grep "public static primary = \['sha'\]" src/domain.objects/DeclaredGithubBranch.ts
grep "public static unique = \['repo', 'name'\]" src/domain.objects/DeclaredGithubBranch.ts
```

**Dependencies:** Phase 2 complete (2.10)

---

### 3.2 Create castToDeclaredGithubBranch Function

**Task:** Implement src/domain.operations/branch/castToDeclaredGithubBranch.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/branch/castToDeclaredGithubBranch.ts
- Exports castToDeclaredGithubBranch function
- Accepts Octokit branch response type and repo reference
- Returns HasMetadata<DeclaredGithubBranch>
- Uses getOrThrow for required fields
- Properly constructs repo Ref

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/branch/castToDeclaredGithubBranch.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify uses getOrThrow
grep "getOrThrow" src/domain.operations/branch/castToDeclaredGithubBranch.ts
```

**Dependencies:** 3.1 (requires DeclaredGithubBranch)

---

### 3.3 Implement getBranch Operation

**Task:** Implement src/domain.operations/branch/getBranch.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/branch/getBranch.ts
- Exports getBranch function wrapped with asProcedure
- Accepts `by: { primary | unique | ref }` parameter
- Returns `HasMetadata<DeclaredGithubBranch> | null`
- Resolves repo reference to owner/name
- Uses github.repos.getBranch API
- Returns null for 404 errors
- Throws HelpfulError for other errors

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/branch/getBranch.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify uses asProcedure
grep "asProcedure" src/domain.operations/branch/getBranch.ts
```

**Dependencies:** 3.2 (requires castToDeclaredGithubBranch)

---

### 3.4 Create getBranch Integration Test

**Task:** Implement src/domain.operations/branch/getBranch.integration.test.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/branch/getBranch.integration.test.ts
- Uses given/then test structure
- Tests getting branch by unique key (repo + name)
- Tests getting branch that doesn't exist (returns null)
- Uses real GitHub API
- Verifies branch properties (sha, name, etc.)

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/branch/getBranch.integration.test.ts

# Run integration test
GITHUB_TOKEN=<token> GITHUB_TEST_OWNER=ehmpathy GITHUB_TEST_REPO=declastruct-github npm run test:integration -- getBranch.integration.test

# Verify test passes
echo $?
```

**Dependencies:** 3.3 (requires getBranch)

---

### 3.5 Implement getBranches Operation

**Task:** Implement src/domain.operations/branch/getBranches.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/branch/getBranches.ts
- Exports getBranches function wrapped with asProcedure
- Accepts `where: { repo: Ref }` parameter
- Accepts optional `page: { range?, limit? }` parameter
- Returns `HasMetadata<DeclaredGithubBranch>[]`
- Resolves repo reference to owner/name
- Uses github.repos.listBranches API
- Handles pagination correctly

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/branch/getBranches.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify uses asProcedure
grep "asProcedure" src/domain.operations/branch/getBranches.ts
```

**Dependencies:** 3.2 (requires castToDeclaredGithubBranch)

---

### 3.6 Create getBranches Integration Test

**Task:** Implement src/domain.operations/branch/getBranches.integration.test.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/branch/getBranches.integration.test.ts
- Uses given/then test structure
- Tests listing branches for a repo
- Verifies returns array of branches
- Uses real GitHub API

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/branch/getBranches.integration.test.ts

# Run integration test
GITHUB_TOKEN=<token> GITHUB_TEST_OWNER=ehmpathy GITHUB_TEST_REPO=declastruct-github npm run test:integration -- getBranches.integration.test

# Verify test passes
echo $?
```

**Dependencies:** 3.5 (requires getBranches)

---

### 3.7 Implement setBranch Operation

**Task:** Implement src/domain.operations/branch/setBranch.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/branch/setBranch.ts
- Exports setBranch function wrapped with asProcedure
- Accepts `PickOne<{ finsert, upsert }>` parameter
- Returns `HasMetadata<DeclaredGithubBranch>`
- Checks existence via getBranch
- For create: uses github.git.createRef with commit SHA
- For create: defaults to default branch SHA if fromBranch not specified
- For rename: uses github.repos.renameBranch
- Handles finsert vs upsert logic

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/branch/setBranch.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify uses getBranch
grep "getBranch" src/domain.operations/branch/setBranch.ts
```

**Dependencies:** 3.3 (requires getBranch), 3.2 (requires castToDeclaredGithubBranch)

---

### 3.8 Create setBranch Unit Test

**Task:** Implement src/domain.operations/branch/setBranch.test.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/branch/setBranch.test.ts
- Uses jest mocking patterns
- Tests finsert behavior
- Tests upsert behavior (create and rename)
- Mocks getBranch responses
- Mocks Octokit API calls

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/branch/setBranch.test.ts

# Run unit test
npm test -- setBranch.test

# Verify test passes
echo $?
```

**Dependencies:** 3.7 (requires setBranch)

---

### 3.9 Create setBranch Integration Test

**Task:** Implement src/domain.operations/branch/setBranch.integration.test.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/branch/setBranch.integration.test.ts
- Uses given/then test structure
- Tests creating new branch
- Tests branch already exists (finsert)
- Uses real GitHub API
- Cleans up test branches after test

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/branch/setBranch.integration.test.ts

# Run integration test
GITHUB_TOKEN=<token> GITHUB_TEST_OWNER=ehmpathy GITHUB_TEST_REPO=declastruct-github npm run test:integration -- setBranch.integration.test

# Verify test passes
echo $?
```

**Dependencies:** 3.7 (requires setBranch)

---

### 3.10 Phase 3 Validation

**Task:** Verify all Phase 3 deliverables are complete

**Acceptance Criteria:**
- All branch resource files exist
- TypeScript compilation succeeds
- All unit tests pass
- All integration tests pass
- getBranch, getBranches, setBranch operations work correctly

**Verification:**
```bash
# Verify all files exist
ls src/domain.objects/DeclaredGithubBranch.ts
ls src/domain.operations/branch/castToDeclaredGithubBranch.ts
ls src/domain.operations/branch/getBranch.ts
ls src/domain.operations/branch/getBranch.integration.test.ts
ls src/domain.operations/branch/getBranches.ts
ls src/domain.operations/branch/getBranches.integration.test.ts
ls src/domain.operations/branch/setBranch.ts
ls src/domain.operations/branch/setBranch.test.ts
ls src/domain.operations/branch/setBranch.integration.test.ts

# Run all tests
npm test -- branch/
npm run test:integration -- branch/

# Verify TypeScript compiles
npx tsc --noEmit
```

**Dependencies:** 3.1-3.9

---

## Phase 4: Repository Configuration Resource Implementation

**Goal:** Implement DeclaredGithubRepoConfig resource operations

### 4.1 Create DeclaredGithubRepoConfig Domain Object

**Task:** Implement src/domain.objects/DeclaredGithubRepoConfig.ts

**Acceptance Criteria:**
- File exists at src/domain.objects/DeclaredGithubRepoConfig.ts
- Exports DeclaredGithubRepoConfig interface with all fields from blueprint
- Uses `Ref<typeof DeclaredGithubRepo>` for repo field
- Exports DeclaredGithubRepoConfig class extending DomainEntity
- Class defines `public static primary = ['repo'] as const`
- Class defines `public static unique = ['repo'] as const`

**Verification:**
```bash
# Verify file exists
ls src/domain.objects/DeclaredGithubRepoConfig.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify uses Ref type
grep "Ref<typeof DeclaredGithubRepo>" src/domain.objects/DeclaredGithubRepoConfig.ts

# Verify class structure
grep "public static primary = \['repo'\]" src/domain.objects/DeclaredGithubRepoConfig.ts
```

**Dependencies:** Phase 3 complete (3.10)

---

### 4.2 Create castToDeclaredGithubRepoConfig Function

**Task:** Implement src/domain.operations/repoConfig/castToDeclaredGithubRepoConfig.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/repoConfig/castToDeclaredGithubRepoConfig.ts
- Exports castToDeclaredGithubRepoConfig function
- Accepts Octokit repository response and extracts config fields
- Returns HasMetadata<DeclaredGithubRepoConfig>
- Uses getOrThrow for required fields
- Extracts only config-related fields (not general repo metadata)

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/repoConfig/castToDeclaredGithubRepoConfig.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify uses getOrThrow
grep "getOrThrow" src/domain.operations/repoConfig/castToDeclaredGithubRepoConfig.ts
```

**Dependencies:** 4.1 (requires DeclaredGithubRepoConfig)

---

### 4.3 Implement getRepoConfig Operation

**Task:** Implement src/domain.operations/repoConfig/getRepoConfig.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/repoConfig/getRepoConfig.ts
- Exports getRepoConfig function wrapped with asProcedure
- Accepts `by: { primary | unique | ref }` parameter (all resolve to repo)
- Returns `HasMetadata<DeclaredGithubRepoConfig> | null`
- Uses github.repos.get API
- Extracts config subset from repo response
- Returns null for 404 errors

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/repoConfig/getRepoConfig.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify uses asProcedure
grep "asProcedure" src/domain.operations/repoConfig/getRepoConfig.ts
```

**Dependencies:** 4.2 (requires castToDeclaredGithubRepoConfig)

---

### 4.4 Create getRepoConfig Integration Test

**Task:** Implement src/domain.operations/repoConfig/getRepoConfig.integration.test.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/repoConfig/getRepoConfig.integration.test.ts
- Uses given/then test structure
- Tests getting repo config for existing repo
- Verifies config fields are populated
- Uses real GitHub API

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/repoConfig/getRepoConfig.integration.test.ts

# Run integration test
GITHUB_TOKEN=<token> GITHUB_TEST_OWNER=ehmpathy GITHUB_TEST_REPO=declastruct-github npm run test:integration -- getRepoConfig.integration.test

# Verify test passes
echo $?
```

**Dependencies:** 4.3 (requires getRepoConfig)

---

### 4.5 Implement setRepoConfig Operation

**Task:** Implement src/domain.operations/repoConfig/setRepoConfig.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/repoConfig/setRepoConfig.ts
- Exports setRepoConfig function wrapped with asProcedure
- Accepts `PickOne<{ finsert, upsert }>` parameter
- Returns `HasMetadata<DeclaredGithubRepoConfig>`
- Checks existence via getRepoConfig
- Uses github.repos.update API with only config fields
- Handles finsert (no-op if exists) vs upsert (always update)

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/repoConfig/setRepoConfig.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify uses getRepoConfig
grep "getRepoConfig" src/domain.operations/repoConfig/setRepoConfig.ts
```

**Dependencies:** 4.3 (requires getRepoConfig), 4.2 (requires castToDeclaredGithubRepoConfig)

---

### 4.6 Create setRepoConfig Unit Test

**Task:** Implement src/domain.operations/repoConfig/setRepoConfig.test.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/repoConfig/setRepoConfig.test.ts
- Uses jest mocking patterns
- Tests finsert behavior
- Tests upsert behavior
- Mocks getRepoConfig responses
- Mocks Octokit API calls

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/repoConfig/setRepoConfig.test.ts

# Run unit test
npm test -- setRepoConfig.test

# Verify test passes
echo $?
```

**Dependencies:** 4.5 (requires setRepoConfig)

---

### 4.7 Create setRepoConfig Integration Test

**Task:** Implement src/domain.operations/repoConfig/setRepoConfig.integration.test.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/repoConfig/setRepoConfig.integration.test.ts
- Uses given/then test structure
- Tests updating repo config settings
- Verifies changes are applied
- Uses real GitHub API
- Restores original settings after test if needed

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/repoConfig/setRepoConfig.integration.test.ts

# Run integration test
GITHUB_TOKEN=<token> GITHUB_TEST_OWNER=ehmpathy GITHUB_TEST_REPO=declastruct-github npm run test:integration -- setRepoConfig.integration.test

# Verify test passes
echo $?
```

**Dependencies:** 4.5 (requires setRepoConfig)

---

### 4.8 Phase 4 Validation

**Task:** Verify all Phase 4 deliverables are complete

**Acceptance Criteria:**
- All repo config resource files exist
- TypeScript compilation succeeds
- All unit tests pass
- All integration tests pass
- getRepoConfig, setRepoConfig operations work correctly

**Verification:**
```bash
# Verify all files exist
ls src/domain.objects/DeclaredGithubRepoConfig.ts
ls src/domain.operations/repoConfig/castToDeclaredGithubRepoConfig.ts
ls src/domain.operations/repoConfig/getRepoConfig.ts
ls src/domain.operations/repoConfig/getRepoConfig.integration.test.ts
ls src/domain.operations/repoConfig/setRepoConfig.ts
ls src/domain.operations/repoConfig/setRepoConfig.test.ts
ls src/domain.operations/repoConfig/setRepoConfig.integration.test.ts

# Run all tests
npm test -- repoConfig/
npm run test:integration -- repoConfig/

# Verify TypeScript compiles
npx tsc --noEmit
```

**Dependencies:** 4.1-4.7

---

## Phase 5: Branch Protection Resource Implementation

**Goal:** Implement DeclaredGithubBranchProtection resource operations

### 5.1 Create DeclaredGithubBranchProtection Domain Object

**Task:** Implement src/domain.objects/DeclaredGithubBranchProtection.ts

**Acceptance Criteria:**
- File exists at src/domain.objects/DeclaredGithubBranchProtection.ts
- Exports DeclaredGithubBranchProtection interface with all fields from blueprint
- Uses `Ref<typeof DeclaredGithubBranch>` for branch field
- Exports DeclaredGithubBranchProtection class extending DomainEntity
- Class defines `public static primary = ['branch'] as const`
- Class defines `public static unique = ['branch'] as const`
- Includes all protection rule fields (enforceAdmins, requiredStatusChecks, etc.)

**Verification:**
```bash
# Verify file exists
ls src/domain.objects/DeclaredGithubBranchProtection.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify uses Ref type
grep "Ref<typeof DeclaredGithubBranch>" src/domain.objects/DeclaredGithubBranchProtection.ts

# Verify class structure
grep "public static primary = \['branch'\]" src/domain.objects/DeclaredGithubBranchProtection.ts
```

**Dependencies:** Phase 4 complete (4.8)

---

### 5.2 Create castToDeclaredGithubBranchProtection Function

**Task:** Implement src/domain.operations/branchProtection/castToDeclaredGithubBranchProtection.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/branchProtection/castToDeclaredGithubBranchProtection.ts
- Exports castToDeclaredGithubBranchProtection function
- Accepts Octokit branch protection response and branch reference
- Returns HasMetadata<DeclaredGithubBranchProtection>
- Properly handles nested protection objects (requiredStatusChecks, requiredPullRequestReviews, restrictions)
- Uses getOrThrow for required fields

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/branchProtection/castToDeclaredGithubBranchProtection.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify uses getOrThrow
grep "getOrThrow" src/domain.operations/branchProtection/castToDeclaredGithubBranchProtection.ts
```

**Dependencies:** 5.1 (requires DeclaredGithubBranchProtection)

---

### 5.3 Implement getBranchProtection Operation

**Task:** Implement src/domain.operations/branchProtection/getBranchProtection.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/branchProtection/getBranchProtection.ts
- Exports getBranchProtection function wrapped with asProcedure
- Accepts `by: { primary | unique | ref }` parameter
- Returns `HasMetadata<DeclaredGithubBranchProtection> | null`
- Resolves branch reference to repo owner/name and branch name
- Uses github.repos.getBranchProtection API
- Returns null for 404 errors (no protection exists)

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/branchProtection/getBranchProtection.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify uses asProcedure
grep "asProcedure" src/domain.operations/branchProtection/getBranchProtection.ts

# Verify handles 404 as null
grep "return null" src/domain.operations/branchProtection/getBranchProtection.ts
```

**Dependencies:** 5.2 (requires castToDeclaredGithubBranchProtection)

---

### 5.4 Create getBranchProtection Integration Test

**Task:** Implement src/domain.operations/branchProtection/getBranchProtection.integration.test.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/branchProtection/getBranchProtection.integration.test.ts
- Uses given/then test structure
- Tests getting branch protection for protected branch
- Tests getting protection for unprotected branch (returns null)
- Uses real GitHub API

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/branchProtection/getBranchProtection.integration.test.ts

# Run integration test
GITHUB_TOKEN=<token> GITHUB_TEST_OWNER=ehmpathy GITHUB_TEST_REPO=declastruct-github npm run test:integration -- getBranchProtection.integration.test

# Verify test passes
echo $?
```

**Dependencies:** 5.3 (requires getBranchProtection)

---

### 5.5 Implement setBranchProtection Operation

**Task:** Implement src/domain.operations/branchProtection/setBranchProtection.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/branchProtection/setBranchProtection.ts
- Exports setBranchProtection function wrapped with asProcedure
- Accepts `PickOne<{ finsert, upsert }>` parameter
- Returns `HasMetadata<DeclaredGithubBranchProtection>`
- Checks existence via getBranchProtection
- Uses github.repos.updateBranchProtection API (PUT entire object)
- Handles removing protection if all fields are null/disabled
- Handles finsert vs upsert logic

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/branchProtection/setBranchProtection.ts

# Verify TypeScript compiles
npx tsc --noEmit

# Verify uses getBranchProtection
grep "getBranchProtection" src/domain.operations/branchProtection/setBranchProtection.ts
```

**Dependencies:** 5.3 (requires getBranchProtection), 5.2 (requires castToDeclaredGithubBranchProtection)

---

### 5.6 Create setBranchProtection Unit Test

**Task:** Implement src/domain.operations/branchProtection/setBranchProtection.test.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/branchProtection/setBranchProtection.test.ts
- Uses jest mocking patterns
- Tests finsert behavior
- Tests upsert behavior (create and update)
- Mocks getBranchProtection responses
- Mocks Octokit API calls

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/branchProtection/setBranchProtection.test.ts

# Run unit test
npm test -- setBranchProtection.test

# Verify test passes
echo $?
```

**Dependencies:** 5.5 (requires setBranchProtection)

---

### 5.7 Create setBranchProtection Integration Test

**Task:** Implement src/domain.operations/branchProtection/setBranchProtection.integration.test.ts

**Acceptance Criteria:**
- File exists at src/domain.operations/branchProtection/setBranchProtection.integration.test.ts
- Uses given/then test structure
- Tests setting branch protection rules
- Tests updating existing protection
- Uses real GitHub API
- Cleans up protection settings after test

**Verification:**
```bash
# Verify file exists
ls src/domain.operations/branchProtection/setBranchProtection.integration.test.ts

# Run integration test
GITHUB_TOKEN=<token> GITHUB_TEST_OWNER=ehmpathy GITHUB_TEST_REPO=declastruct-github npm run test:integration -- setBranchProtection.integration.test

# Verify test passes
echo $?
```

**Dependencies:** 5.5 (requires setBranchProtection)

---

### 5.8 Phase 5 Validation

**Task:** Verify all Phase 5 deliverables are complete

**Acceptance Criteria:**
- All branch protection resource files exist
- TypeScript compilation succeeds
- All unit tests pass
- All integration tests pass
- getBranchProtection, setBranchProtection operations work correctly

**Verification:**
```bash
# Verify all files exist
ls src/domain.objects/DeclaredGithubBranchProtection.ts
ls src/domain.operations/branchProtection/castToDeclaredGithubBranchProtection.ts
ls src/domain.operations/branchProtection/getBranchProtection.ts
ls src/domain.operations/branchProtection/getBranchProtection.integration.test.ts
ls src/domain.operations/branchProtection/setBranchProtection.ts
ls src/domain.operations/branchProtection/setBranchProtection.test.ts
ls src/domain.operations/branchProtection/setBranchProtection.integration.test.ts

# Run all tests
npm test -- branchProtection/
npm run test:integration -- branchProtection/

# Verify TypeScript compiles
npx tsc --noEmit
```

**Dependencies:** 5.1-5.7

---

## Phase 6: Cleanup and Migration

**Goal:** Remove AWS Lambda code and finalize GitHub-only codebase

### 6.1 Remove AWS Lambda Domain Object

**Task:** Delete src/domain.objects/DeclaredAwsLambda.ts

**Acceptance Criteria:**
- File no longer exists at src/domain.objects/DeclaredAwsLambda.ts
- TypeScript compilation still succeeds (no orphaned imports)

**Verification:**
```bash
# Verify file doesn't exist
test ! -f src/domain.objects/DeclaredAwsLambda.ts && echo "File removed successfully"

# Verify TypeScript compiles
npx tsc --noEmit
```

**Dependencies:** Phase 5 complete (5.8)

---

### 6.2 Remove AWS Context Object

**Task:** Delete src/domain.objects/ContextAwsApi.ts

**Acceptance Criteria:**
- File no longer exists at src/domain.objects/ContextAwsApi.ts
- TypeScript compilation still succeeds

**Verification:**
```bash
# Verify file doesn't exist
test ! -f src/domain.objects/ContextAwsApi.ts && echo "File removed successfully"

# Verify TypeScript compiles
npx tsc --noEmit
```

**Dependencies:** 6.1

---

### 6.3 Remove Lambda Operations Directory

**Task:** Delete src/domain.operations/lambda/ directory and all contents

**Acceptance Criteria:**
- Directory no longer exists at src/domain.operations/lambda/
- All lambda operation files removed
- TypeScript compilation still succeeds

**Verification:**
```bash
# Verify directory doesn't exist
test ! -d src/domain.operations/lambda && echo "Directory removed successfully"

# Verify TypeScript compiles
npx tsc --noEmit
```

**Dependencies:** 6.2

---

### 6.4 Remove AWS Test Assets

**Task:** Delete AWS-related test helper files

**Files to remove:**
- src/__test_assets__/getSampleAwsApiContext.ts
- src/__test_assets__/getSampleLambda.ts
- src/__test_assets__/lambda.sample.md
- src/__test_assets__/lambda.sample.sh
- src/__test_assets__/lambda.sample.zip

**Acceptance Criteria:**
- All 5 files no longer exist
- TypeScript compilation still succeeds

**Verification:**
```bash
# Verify files don't exist
test ! -f src/__test_assets__/getSampleAwsApiContext.ts && \
test ! -f src/__test_assets__/getSampleLambda.ts && \
test ! -f src/__test_assets__/lambda.sample.md && \
test ! -f src/__test_assets__/lambda.sample.sh && \
test ! -f src/__test_assets__/lambda.sample.zip && \
echo "All AWS test assets removed successfully"

# Verify TypeScript compiles
npx tsc --noEmit
```

**Dependencies:** 6.3

---

### 6.5 Remove AWS SDK Dependency

**Task:** Remove @aws-sdk/client-lambda from package.json

**Acceptance Criteria:**
- Package.json no longer contains @aws-sdk/client-lambda
- npm install completes successfully
- No orphaned AWS SDK packages in node_modules

**Verification:**
```bash
# Verify dependency removed from package.json
! grep -q "@aws-sdk/client-lambda" package.json && echo "AWS SDK removed from package.json"

# Run clean install
rm -rf node_modules package-lock.json
npm install

# Verify AWS SDK not installed
test ! -d node_modules/@aws-sdk && echo "AWS SDK not in node_modules"
```

**Dependencies:** 6.4

---

### 6.6 Update Package Metadata

**Task:** Update package.json description and keywords to reflect GitHub focus

**Acceptance Criteria:**
- package.json description mentions GitHub (not AWS)
- package.json keywords include relevant GitHub terms
- package.json name remains "declastruct-github"

**Verification:**
```bash
# Verify package name
grep '"name": "declastruct-github"' package.json

# Verify description mentions GitHub
grep -i "github" package.json | grep "description"

# Verify keywords updated
grep -i "keywords" package.json -A 5
```

**Dependencies:** 6.5

---

### 6.7 Verify All Tests Pass

**Task:** Run complete test suite to ensure nothing is broken

**Acceptance Criteria:**
- All unit tests pass
- All integration tests pass (with proper GitHub credentials)
- No test files reference AWS Lambda code
- TypeScript compilation succeeds with no errors

**Verification:**
```bash
# Run all unit tests
npm test

# Run all integration tests
GITHUB_TOKEN=<token> GITHUB_TEST_OWNER=ehmpathy GITHUB_TEST_REPO=declastruct-github npm run test:integration

# Verify no AWS references in tests
! grep -r "Lambda\|AWS\|aws-sdk" src/**/*.test.ts && echo "No AWS references in tests"

# Verify TypeScript compiles
npx tsc --noEmit
```

**Dependencies:** 6.6

---

### 6.8 Phase 6 Validation

**Task:** Verify cleanup is complete and codebase is GitHub-only

**Acceptance Criteria:**
- No AWS Lambda files remain
- No AWS SDK dependencies
- All tests pass
- TypeScript compiles successfully
- Codebase only contains GitHub-related code

**Verification:**
```bash
# Verify no AWS files exist
! find src -name "*Lambda*" -o -name "*Aws*" && echo "No AWS files found"

# Verify no AWS dependencies
! grep -i "aws" package.json && echo "No AWS dependencies"

# Run all tests
npm test
npm run test:integration

# Verify TypeScript compiles
npx tsc --noEmit

# Verify git status is clean or only has intended changes
git status
```

**Dependencies:** 6.1-6.7

---

## Final Validation

### Complete System Test

**Task:** End-to-end validation of all resources and operations

**Acceptance Criteria:**
- All 4 resource types (Repo, Branch, RepoConfig, BranchProtection) fully functional
- All operations (get, gets, set, cast) work correctly
- All tests pass (unit and integration)
- TypeScript compilation succeeds
- No AWS code remains
- Documentation is accurate

**Verification:**
```bash
# Verify all domain objects exist
ls src/domain.objects/DeclaredGithubRepo.ts
ls src/domain.objects/DeclaredGithubBranch.ts
ls src/domain.objects/DeclaredGithubRepoConfig.ts
ls src/domain.objects/DeclaredGithubBranchProtection.ts
ls src/domain.objects/ContextGithubApi.ts

# Verify all operation directories exist
ls -d src/domain.operations/repo/
ls -d src/domain.operations/branch/
ls -d src/domain.operations/repoConfig/
ls -d src/domain.operations/branchProtection/

# Verify no AWS code
! find src -type f -name "*.ts" -exec grep -l "Lambda\|@aws-sdk" {} \; && echo "No AWS references"

# Run full test suite
npm test
npm run test:integration

# Verify TypeScript compiles
npx tsc --noEmit

# Check build succeeds
npm run build
```

**Dependencies:** All phases complete (6.8)

---

## Summary

This roadmap implements declarative GitHub resource management following these principles:

1. **Ordered dependencies** - Each phase builds on the previous, starting with infrastructure and progressively adding resources
2. **Behavioral acceptance criteria** - Clear, testable requirements for each task
3. **Behavioral verification** - Concrete bash commands to validate completion
4. **Pattern consistency** - All resources follow the established AWS Lambda patterns exactly
5. **Test coverage** - Both unit and integration tests for all operations
6. **Clean migration** - Complete removal of AWS code after GitHub implementation is complete

### Resource Implementation Order:
1. **Repo** (simplest, no dependencies)
2. **Branch** (references Repo)
3. **RepoConfig** (subset of Repo)
4. **BranchProtection** (references Branch)

### Test Strategy:
- Unit tests with mocks for logic validation
- Integration tests against real GitHub API for end-to-end verification
- Environment variables for test credentials and resources

### Success Metrics:
- ✅ 4 resources fully implemented
- ✅ All operations follow established patterns
- ✅ 100% test pass rate
- ✅ TypeScript compilation with no errors
- ✅ AWS code completely removed
- ✅ Stateless, Terraform-free GitHub management
