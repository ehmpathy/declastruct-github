# Phase 4 Implementation: Repository Configuration Resource

## Overview
This document tracks the implementation of Phase 4 from the roadmap: Repository Configuration Resource Implementation.

## Reference Documents
- Roadmap: `.behaviors/v2025_11_22.declastruct-github/4.1.roadmap.v2.i1.md`
- Blueprint: `.behaviors/v2025_11_22.declastruct-github/3.3.blueprint.v2.i1.md`

## Tasks Completed

### ✅ Task 4.1: Create DeclaredGithubRepoConfig Domain Object
**File:** `src/domain.objects/DeclaredGithubRepoConfig.ts`

**Implementation:**
- Created interface with all required config fields from blueprint
- Used `Ref<typeof DeclaredGithubRepo>` for repo field
- Exported class extending `DomainEntity<DeclaredGithubRepoConfig>`
- Defined `public static primary = ['repo'] as const`
- Defined `public static unique = ['repo'] as const`
- Added proper JSDoc comments following comment discipline brief

**Acceptance Criteria Met:**
- ✅ File exists at correct path
- ✅ Interface exports all fields from blueprint
- ✅ Uses Ref for repo field
- ✅ Class extends DomainEntity
- ✅ Primary and unique keys defined correctly

### ✅ Task 4.2: Create castToDeclaredGithubRepoConfig Function
**File:** `src/domain.operations/repoConfig/castToDeclaredGithubRepoConfig.ts`

**Implementation:**
- Created cast function following existing patterns
- Uses `getOrThrow` helper for required fields
- Maps GitHub API snake_case to domain camelCase
- Handles optional fields appropriately
- Returns `HasMetadata<DeclaredGithubRepoConfig>`
- Takes `{ repo: GithubRepoResponse, repoRef: Ref<typeof DeclaredGithubRepo> }` as input

**Acceptance Criteria Met:**
- ✅ File exists at correct path
- ✅ Exports castToDeclaredGithubRepoConfig function
- ✅ Takes GitHub API response and repo reference
- ✅ Returns HasMetadata<DeclaredGithubRepoConfig>
- ✅ Maps all fields from API response
- ✅ Handles optional vs required fields correctly

### ✅ Task 4.3: Implement getRepoConfig Operation
**File:** `src/domain.operations/repoConfig/getRepoConfig.ts`

**Implementation:**
- Created getRepoConfig operation using `asProcedure` wrapper
- Accepts `by.unique` reference with repo field
- Uses cached `getGithubClient`
- Calls `github.repos.get()` API
- Returns null for 404/Not Found
- Throws `HelpfulError` for other failures
- Follows input-context signature pattern

**Technical Details:**
- Used type assertion `as { owner: string; name: string }` to work with `Ref<>` type
- Properly passes repoRef through to cast function

**Acceptance Criteria Met:**
- ✅ File exists at correct path
- ✅ Uses asProcedure wrapper
- ✅ Accepts by.unique reference
- ✅ Uses getGithubClient
- ✅ Returns null for 404
- ✅ Throws HelpfulError for failures

### ✅ Task 4.4: Create getRepoConfig Integration Test
**File:** `src/domain.operations/repoConfig/getRepoConfig.integration.test.ts`

**Implementation:**
- Created test using `given/then` pattern from test-fns
- Uses getSampleGithubContext and getSampleRepo helpers
- Tests successful retrieval of config for existing repo
- Tests null return for non-existent repo
- Validates required boolean fields are present
- Validates defaultBranch is defined

**Acceptance Criteria Met:**
- ✅ File exists at correct path
- ✅ Tests successful config retrieval
- ✅ Tests 404/not found case
- ✅ Uses test-fns patterns
- ✅ Uses sample context helpers

### ✅ Task 4.5: Implement setRepoConfig Operation
**File:** `src/domain.operations/repoConfig/setRepoConfig.ts`

**Implementation:**
- Created setRepoConfig operation using `asProcedure` wrapper
- Supports both findsert and upsert patterns
- Calls getRepoConfig to check if config exists
- Returns early for findsert if config exists
- Always uses `github.repos.update()` (no create operation since config is part of repo)
- Maps all config fields to GitHub API parameters
- Uses cached `getGithubClient`
- Returns `HasMetadata<DeclaredGithubRepoConfig>`

**Technical Details:**
- Used type assertion for accessing repo.owner and repo.name
- Config is subset of repo, so always uses update operation

**Acceptance Criteria Met:**
- ✅ File exists at correct path
- ✅ Uses asProcedure wrapper
- ✅ Supports findsert/upsert patterns
- ✅ Returns early for findsert if exists
- ✅ Updates config via repos.update API
- ✅ Uses getGithubClient
- ✅ Throws HelpfulError for failures

### ✅ Task 4.6: Create setRepoConfig Unit Test
**File:** `src/domain.operations/repoConfig/setRepoConfig.test.ts`

**Implementation:**
- Created comprehensive unit tests with Jest mocks
- Mocks getGithubClient, castToDeclaredGithubRepoConfig, and getRepoConfig
- Tests findsert early return when config exists
- Tests upsert updates config when config exists
- Tests update operation when config doesn't exist
- Validates correct API parameters passed to update

**Test Coverage:**
1. Returns early for findsert if config exists (before)
2. Updates repo config if upsert and config exists (before)
3. Creates (updates) repo config if config does not exist (before = null)

**Acceptance Criteria Met:**
- ✅ File exists at correct path
- ✅ Tests findsert early return
- ✅ Tests upsert update path
- ✅ Tests creation (update) path
- ✅ Mocks external dependencies
- ✅ All tests passing

### ✅ Task 4.7: Create setRepoConfig Integration Test
**File:** `src/domain.operations/repoConfig/setRepoConfig.integration.test.ts`

**Implementation:**
- Created integration tests against live GitHub API
- Uses declastruct-github-demo repo for testing
- Tests actual config updates
- Tests findsert returns existing config without changes
- Uses getSampleGithubContext and getSampleRepo helpers

**Test Coverage:**
1. Updates repo config settings (tests upsert path)
2. Returns existing config for findsert (tests early return)

**Acceptance Criteria Met:**
- ✅ File exists at correct path
- ✅ Tests against live API
- ✅ Tests upsert updates
- ✅ Tests findsert early return
- ✅ Uses sample context helpers

### ✅ Task 4.8: Phase 4 Validation
**Validation Steps Performed:**

1. **TypeScript Compilation:**
   - ✅ Fixed type errors with Ref<> type assertions
   - ✅ Build passes with no errors
   - Command: `npm run build`

2. **Unit Tests:**
   - ✅ setRepoConfig unit tests pass (3/3 tests)
   - Command: `LOCALLY=true npx jest src/domain.operations/repoConfig/setRepoConfig.test.ts`

3. **Integration Tests:**
   - ✅ getRepoConfig integration tests pass (2/2 tests)
   - ✅ setRepoConfig integration tests pass (2/2 tests)
   - ✅ All tests run against declastruct-github-demo repo
   - Command: `source .agent/repo=.this/skills/use.demorepo.token.sh && LOCALLY=true npx jest src/domain.operations/repoConfig -c ./jest.integration.config.ts --forceExit --verbose --runInBand`

4. **Code Quality:**
   - ✅ Follows mechanic briefs:
     - args:input-context pattern ✅
     - funcs:arrow-only ✅
     - comment-discipline (.what/.why comments) ✅
     - flow:narrative (early returns, no nested if/else) ✅
     - arch:directional-deps (access → domain.operations → domain.objects) ✅

5. **Files Created:**
   - ✅ src/domain.objects/DeclaredGithubRepoConfig.ts
   - ✅ src/domain.operations/repoConfig/castToDeclaredGithubRepoConfig.ts
   - ✅ src/domain.operations/repoConfig/getRepoConfig.ts
   - ✅ src/domain.operations/repoConfig/getRepoConfig.integration.test.ts
   - ✅ src/domain.operations/repoConfig/setRepoConfig.ts
   - ✅ src/domain.operations/repoConfig/setRepoConfig.test.ts
   - ✅ src/domain.operations/repoConfig/setRepoConfig.integration.test.ts

**Integration Test Fixes Applied:**
- Updated cast function to handle optional fields (removed `getOrThrow` for config fields)
- Changed all integration tests to use `declastruct-github-demo` repo instead of `declastruct-github` repo
- Ensures tests work with demo repo token permissions

## Summary

Phase 4 has been successfully completed. All tasks have been implemented following the roadmap specifications and blueprint design. The implementation:

- Created the DeclaredGithubRepoConfig domain object with proper 1:1 relationship to DeclaredGithubRepo
- Implemented cast function to transform GitHub API responses to domain model
- Implemented getRepoConfig operation with proper error handling
- Implemented setRepoConfig operation supporting findsert/upsert patterns
- Created comprehensive unit and integration tests
- All tests passing
- Build succeeds with no type errors
- Follows all mechanic briefs and architectural patterns

**Next Steps:** Ready to proceed with Phase 5 of the roadmap or await further instructions.
