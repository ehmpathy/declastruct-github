# phase 2 execution: implement DAOs

## overview

this document tracks the execution of phase 2 from the blueprint at `.behaviors/v2025_11_23.declastruct-interface/3.3.blueprint.v1.i1.md`

**objective**: implement four DAO wrappers that adapt existing github operations to the declastruct interface

## implementation summary

### 1. created src/access/daos directory structure

created directory `src/access/daos/` to house all DAO implementations following the repo's layered architecture pattern

### 2. implemented DeclaredGithubRepoDao

**file**: `src/access/daos/DeclaredGithubRepoDao.ts`

**what**: declastruct DAO wrapper for github repository resources

**implementation details**:
- wraps existing `getRepo` and `setRepo` operations
- implements both `get` operations: `byUnique` and `byRef`
- implements both `set` operations: `finsert` and `upsert`
- uses `isRefByUnique({ of: DeclaredGithubRepo })` type guard for ref checking
- context type: `ContextGithubApi & ContextLogTrail`

**key code patterns**:
```typescript
get: {
  byUnique: async (input, context) => {
    return getRepo({ by: { unique: input } }, context);
  },
  byRef: async (input, context) => {
    if (isRefByUnique({ of: DeclaredGithubRepo })(input))
      return getRepo({ by: { unique: input } }, context);
    UnexpectedCodePathError.throw('unsupported ref type', { input });
  },
},
set: {
  finsert: async (input, context) => {
    return setRepo({ finsert: input }, context);
  },
  upsert: async (input, context) => {
    return setRepo({ upsert: input }, context);
  },
},
```

### 3. implemented DeclaredGithubBranchDao

**file**: `src/access/daos/DeclaredGithubBranchDao.ts`

**what**: declastruct DAO wrapper for github branch resources

**implementation details**:
- wraps existing `getBranch` and `setBranch` operations
- implements both `get` operations: `byUnique` and `byRef`
- implements only `finsert` in `set` operations (branches are immutable after creation)
- uses same type guard pattern as RepoDao
- context type: `ContextGithubApi & ContextLogTrail`

**note**: branches do not support upsert since they cannot be modified after creation, only the `finsert` operation is available

### 4. implemented DeclaredGithubRepoConfigDao

**file**: `src/access/daos/DeclaredGithubRepoConfigDao.ts`

**what**: declastruct DAO wrapper for github repository configuration resources

**implementation details**:
- wraps existing `getRepoConfig` and `setRepoConfig` operations
- implements both `get` operations: `byUnique` and `byRef`
- implements both `set` operations: `finsert` and `upsert`
- both `finsert` and `upsert` call the same underlying operation: `setRepoConfig({ upsert: input }, context)`
- context type: `ContextGithubApi & ContextLogTrail`

**note**: config is always upserted - there is no separate finsert behavior at the underlying operation level, so both DAO methods delegate to the same upsert operation

### 5. implemented DeclaredGithubBranchProtectionDao

**file**: `src/access/daos/DeclaredGithubBranchProtectionDao.ts`

**what**: declastruct DAO wrapper for github branch protection resources

**implementation details**:
- wraps existing `getBranchProtection` and `setBranchProtection` operations
- implements both `get` operations: `byUnique` and `byRef`
- implements both `set` operations: `finsert` and `upsert`
- both `finsert` and `upsert` call the same underlying operation: `setBranchProtection({ upsert: input }, context)`
- context type: `ContextGithubApi & ContextLogTrail`

**note**: protection rules are always upserted - no separate finsert behavior at the underlying operation level

### 6. updated provider to use real DAOs

**file**: `src/domain.operations/provider/getDeclastructGithubProvider.ts`

**changes**:
- replaced placeholder DAO implementations with real DAO imports
- imported all four DAOs from `src/access/daos/`
- assembled DAOs into provider configuration

**final DAO assembly**:
```typescript
const daos = {
  DeclaredGithubRepo: DeclaredGithubRepoDao,
  DeclaredGithubBranch: DeclaredGithubBranchDao,
  DeclaredGithubRepoConfig: DeclaredGithubRepoConfigDao,
  DeclaredGithubBranchProtection: DeclaredGithubBranchProtectionDao,
};
```

## issues encountered and resolved

### issue 1: wrong context type
**problem**: initially attempted to use `VisualogicContext` from visualogic package
**resolution**: corrected to use `ContextLogTrail` from `simple-log-methods` package
**fix**: updated all DAO type signatures to use `ContextGithubApi & ContextLogTrail`

### issue 2: wrong package name
**problem**: initially used `simple-logfirst` as package name
**resolution**: corrected to `simple-log-methods`
**fix**: updated import statement to `import { ContextLogTrail } from 'simple-log-methods'`

### issue 3: log passed as input property
**problem**: initially tried to pass log as part of input object in provider factory
**resolution**: corrected to pass via context parameter following (input, context) pattern
**fix**: updated signature to `getDeclastructGithubProvider(input, context: ContextLogTrail)`

### issue 4: byRef property access error
**problem**: byRef implementations tried to access `input.unique` directly, but input was already the unique keys object
**resolution**: changed from `{ unique: input.unique }` to `{ unique: input }` to properly wrap the ref
**fix**: applied to all four DAOs' byRef implementations

### issue 5: missing finsert property
**problem**: RepoConfigDao and BranchProtectionDao only had upsert in set operations, but DeclastructDao interface requires finsert
**resolution**: added finsert method that calls the same underlying upsert operation
**rationale**: for these resources, both finsert and upsert have the same behavior at the github API level

## verification

### typescript compilation
ran `npx tsc -p ./tsconfig.build.json --noEmit` - compilation passed successfully with no errors

### code style compliance
all implementations follow mechanic role standards:
- arrow functions with (input, context) pattern
- .what and .why jsdoc comments on all named procedures
- code paragraph comments explaining intent
- immutable operations using existing domain operations
- proper error handling with `UnexpectedCodePathError.throw`

## phase 2 completion

✅ all four DAOs implemented and integrated
✅ provider updated to use real DAOs
✅ typescript compilation verified
✅ code style compliance verified

phase 2 is complete and ready for testing
